<!DOCTYPE html>
<html lang="en">
<!--
    Admin Dashboard v2.1.0 - 2024-12-21

    🎯 LATEST CHANGES:
    - ✅ Complete Trigger Editing System (showEditTriggerModal, updateTrigger)
    - ✅ Fixed trigger ID transmission and data structure issues
    - ✅ Added comprehensive error handling and validation
    - ✅ DeepSeek Settings fully functional with hotel-specific configurations

    📝 See admin_dashboard_changelog.md for complete version history
    🔧 Total Functions: 50+ | API Endpoints: 15+ | Lines: 4800+
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Hotel Bot - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/admin_dashboard.css" rel="stylesheet">
    <style>
        /* Admin Dashboard Styles - Inline for immediate effect */
        body {
            background-color: #f8f9fa !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
        }

        nav.sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            min-height: 100vh !important;
            max-height: 100vh !important;
            color: white !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 250px !important;
            z-index: 1000 !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1) !important;
        }

        nav.sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            padding: 12px 20px !important;
            border-radius: 8px !important;
            margin: 4px 12px !important;
            transition: all 0.3s ease !important;
            text-decoration: none !important;
        }

        nav.sidebar .nav-link:hover,
        nav.sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            transform: translateX(5px) !important;
        }

        div.main-content {
            margin-left: 350px !important;
            padding: 20px !important;
            min-height: 100vh !important;
            width: calc(100% - 350px) !important;
            box-sizing: border-box !important;
            position: relative !important;
            left: 0 !important;
            top: 0 !important;
        }

        /* FORCE main-content positioning */
        .main-content {
            margin-left: 350px !important;
            padding: 20px !important;
            width: calc(100% - 350px) !important;
            box-sizing: border-box !important;
        }

        /* FORCE all content sections */
        .content-section {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }

        /* FORCE container positioning */
        .container-fluid {
            margin-left: 0 !important;
            padding-left: 15px !important;
        }

        /* SPECIFIC FIXES for DeepSeek sections */
        #deepseek-settings-section,
        #deepseek-config-section,
        #deepseek-testing-section {
            margin-left: 0 !important;
            padding-left: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        #deepseek-settings-section .container-fluid,
        #deepseek-config-section .container-fluid,
        #deepseek-testing-section .container-fluid {
            margin-left: 0 !important;
            padding-left: 15px !important;
            width: 100% !important;
        }

        /* EMERGENCY FIX - if still overlapping */
        body .main-content {
            margin-left: 350px !important;
            transform: translateX(0) !important;
        }

        /* Ensure sidebar doesn't interfere */
        .sidebar {
            z-index: 1000 !important;
        }

        .main-content {
            z-index: 1 !important;
            position: relative !important;
        }

        /* New page styles - SAFE LAYOUT */
        .deepseek-page {
            margin-left: 280px !important;
            padding: 20px !important;
            max-width: 1200px !important;
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .deepseek-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .deepseek-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .deepseek-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .deepseek-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0;
        }

        .deepseek-content {
            padding: 30px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 1rem 1.5rem;
        }

        .nav-tabs .nav-link.active {
            background-color: #f8f9fa;
            color: #495057;
            border-bottom: 3px solid #007bff;
        }

        .nav-tabs .nav-link:hover {
            border-color: transparent;
            color: #007bff;
        }

        .chat-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .max-width-75 {
            max-width: 75%;
        }

        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .form-range::-webkit-slider-thumb {
            background: #007bff;
        }

        .form-range::-moz-range-thumb {
            background: #007bff;
            border: none;
        }

        .alert {
            border: none;
            border-radius: 0.5rem;
        }

        .btn {
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .badge {
            font-weight: 500;
        }

        .progress {
            height: 8px;
            border-radius: 4px;
        }

        .border {
            border-color: #e9ecef !important;
        }

        .text-muted {
            color: #6c757d !important;
        }

        /* Animation for loading states */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* NUCLEAR OPTION - Force all content to the right */
        * {
            box-sizing: border-box !important;
        }

        .main-content,
        .main-content *,
        #deepseek-settings-section,
        #deepseek-config-section,
        #deepseek-testing-section {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }

        /* Force the main content container to be positioned correctly */
        .main-content {
            position: absolute !important;
            left: 250px !important;
            right: 0 !important;
            width: auto !important;
            margin-left: 0 !important;
            padding: 20px !important;
        }

        div.card {
            border: none !important;
            border-radius: 15px !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            transition: transform 0.3s ease !important;
            margin-bottom: 20px !important;
        }

        div.card:hover {
            transform: translateY(-2px) !important;
        }

        /* Mobile menu toggle button */
        button.mobile-menu-toggle {
            display: none !important;
            position: fixed !important;
            top: 20px !important;
            left: 20px !important;
            z-index: 1001 !important;
            background: #667eea !important;
            color: white !important;
            border: none !important;
            border-radius: 5px !important;
            padding: 10px !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            button.mobile-menu-toggle {
                display: block !important;
            }

            nav.sidebar {
                transform: translateX(-100%) !important;
                transition: transform 0.3s ease !important;
            }

            nav.sidebar.show {
                transform: translateX(0) !important;
            }

            div.main-content {
                margin-left: 0 !important;
                padding: 15px !important;
                padding-top: 70px !important;
                width: 100% !important;
            }
        }

        /* Content sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Sidebar title styling */
        .sidebar-title {
            color: white !important;
            font-size: 1.2rem !important;
            font-weight: 600 !important;
            margin-bottom: 1.5rem !important;
            padding: 0 20px !important;
        }

        /* Navigation improvements */
        .sidebar .nav {
            padding: 0 !important;
            max-height: calc(100vh - 100px) !important;
            overflow-y: auto !important;
        }

        .sidebar .nav-item {
            margin-bottom: 2px !important;
            flex-shrink: 0 !important;
        }

        /* Sidebar header */
        .sidebar .p-4 {
            padding: 1rem !important;
            flex-shrink: 0 !important;
        }

        .sidebar-title {
            font-size: 1.1rem !important;
            margin-bottom: 1rem !important;
        }

        /* Card header improvements */
        .card-header {
            background-color: #f8f9fa !important;
            border-bottom: 1px solid #e9ecef !important;
            font-weight: 600 !important;
        }

        .card-header h5 {
            margin-bottom: 0 !important;
            color: #495057 !important;
        }

        /* Button improvements */
        .btn {
            border-radius: 8px !important;
            font-weight: 500 !important;
        }

        /* Table improvements */
        .table {
            margin-bottom: 0 !important;
        }

        .table th {
            border-top: none !important;
            font-weight: 600 !important;
            color: #495057 !important;
        }

        /* Metric cards */
        .metric-card {
            text-align: center !important;
            padding: 1.5rem !important;
        }

        .metric-value {
            font-size: 2.5rem !important;
            font-weight: 700 !important;
            margin-bottom: 0.5rem !important;
        }

        .metric-label {
            color: #6c757d !important;
            font-size: 0.875rem !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        /* SIMPLIFIED: Content sections positioning */
        .content-section {
            display: none !important;
            padding: 20px !important;
            margin: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
            position: relative !important;
            z-index: 1 !important;
            margin-left: 0 !important; /* Don't override main-content margin */
        }

        .content-section.active {
            display: block !important;
        }

        /* CRITICAL FIX: Container fluid in DeepSeek sections */
        .content-section .container-fluid {
            padding-left: 0 !important;
            padding-right: 0 !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
        }

        /* Fix Bootstrap grid negative margins */
        .content-section .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        /* Ensure proper column padding */
        .content-section .col-lg-8,
        .content-section .col-lg-4,
        .content-section .col-12,
        .content-section .col-md-8,
        .content-section .col-md-4 {
            padding-left: 15px !important;
            padding-right: 15px !important;
        }

        /* Ensure main content has proper scrolling */
        .main-content {
            overflow-y: auto !important;
            max-height: 100vh !important;
        }


    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Styles moved to external CSS file -->

</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="p-4">
            <h4 class="mb-4">
                <i class="fas fa-hotel me-2"></i>
                Hotel Bot Admin
            </h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#dashboard-section" data-section="dashboard-section">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#hotels-section" data-section="hotels-section">
                        <i class="fas fa-building me-2"></i>
                        Hotels
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#conversations-section" data-section="conversations-section">
                        <i class="fas fa-comments me-2"></i>
                        Conversations
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#triggers-section" data-section="triggers-section">
                        <i class="fas fa-bolt me-2"></i>
                        Triggers
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#templates-section" data-section="templates-section">
                        <i class="fas fa-file-alt me-2"></i>
                        Templates
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#sentiment-analytics-section" data-section="sentiment-analytics-section">
                        <i class="fas fa-heart me-2"></i>
                        Sentiment Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#users-section" data-section="users-section">
                        <i class="fas fa-users me-2"></i>
                        Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#analytics-section" data-section="analytics-section">
                        <i class="fas fa-chart-bar me-2"></i>
                        Analytics
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#monitoring-section" data-section="monitoring-section">
                        <i class="fas fa-heartbeat me-2"></i>
                        Monitoring
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#security-section" data-section="security-section">
                        <i class="fas fa-shield-alt me-2"></i>
                        Security
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#deepseek-testing-section" data-section="deepseek-testing-section">
                        <i class="fas fa-flask me-2"></i>
                        DeepSeek Testing
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#deepseek-settings-section" data-section="deepseek-settings-section">
                        <i class="fas fa-cog me-2"></i>
                        DeepSeek Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#ai-configuration-section" data-section="ai-configuration-section">
                        <i class="fas fa-brain me-2"></i>
                        AI Configuration
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 rounded shadow-sm">
            <div class="container-fluid">
                <span class="navbar-brand">WhatsApp Hotel Bot Dashboard</span>
                <div class="d-flex align-items-center">
                    <span class="me-3">
                        <i class="fas fa-circle text-success me-1"></i>
                        System Online
                    </span>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <i class="fas fa-building fa-2x mb-2"></i>
                            <h3 id="total-hotels" class="mb-1">-</h3>
                            <p class="mb-0">Total Hotels</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card-success">
                        <div class="card-body text-center">
                            <i class="fas fa-comments fa-2x mb-2"></i>
                            <h3 id="total-messages" class="mb-1">-</h3>
                            <p class="mb-0">Messages Today</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card-warning">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <h3 id="active-guests" class="mb-1">-</h3>
                            <p class="mb-0">Active Guests</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card-info">
                        <div class="card-body text-center">
                            <i class="fas fa-robot fa-2x mb-2"></i>
                            <h3 id="ai-responses" class="mb-1">-</h3>
                            <p class="mb-0">AI Responses</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Message Volume (Last 7 Days)</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="messageChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Hotel Activity</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="hotelChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Messages</h5>
                        </div>
                        <div class="card-body">
                            <div id="recent-messages" class="loading">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">System Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="system-status">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Database</span>
                                    <span class="status-badge status-active">Active</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>WhatsApp API</span>
                                    <span class="status-badge status-active">Connected</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>AI Service</span>
                                    <span class="status-badge status-active">Online</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Cache</span>
                                    <span class="status-badge status-active">Running</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotels Section -->
        <div id="hotels-section" class="content-section" style="display: none;">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Hotels List</h5>
                            <button class="btn btn-primary btn-sm" onclick="showCreateHotelForm()">
                                <i class="fas fa-plus me-1"></i>Add Hotel
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="hotels-list">
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading hotels...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card" id="create-hotel-card" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">Create New Hotel</h5>
                        </div>
                        <div class="card-body">
                            <form id="create-hotel-form">
                                <div class="mb-3">
                                    <label for="hotel-name" class="form-label">Hotel Name</label>
                                    <input type="text" class="form-control" id="hotel-name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="whatsapp-number" class="form-label">WhatsApp Number</label>
                                    <input type="tel" class="form-control" id="whatsapp-number" placeholder="+1234567890" required>
                                </div>
                                <div class="mb-3">
                                    <label for="green-api-instance" class="form-label">Green API Instance ID</label>
                                    <input type="text" class="form-control" id="green-api-instance">
                                </div>
                                <div class="mb-3">
                                    <label for="green-api-token" class="form-label">Green API Token</label>
                                    <input type="text" class="form-control" id="green-api-token">
                                </div>
                                <div class="mb-3">
                                    <label for="hotel-deepseek-api-key" class="form-label">DeepSeek API Key</label>
                                    <input type="text" class="form-control" id="hotel-deepseek-api-key">
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success">Create Hotel</button>
                                    <button type="button" class="btn btn-secondary" onclick="hideCreateHotelForm()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="users-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">User Management</h5>
                </div>
                <div class="card-body">
                    <div id="users-list">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading users...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Analytics</h5>
                </div>
                <div class="card-body">
                    <div id="analytics-content">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading analytics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="monitoring-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Monitoring</h5>
                </div>
                <div class="card-body">
                    <div id="monitoring-content">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading monitoring data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="security-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Security Settings</h5>
                </div>
                <div class="card-body">
                    <div id="security-content">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading security data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <!-- Conversations Section -->
        <div id="conversations-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-comments me-2"></i>Conversations Management</h5>
                    <button class="btn btn-primary btn-sm" onclick="loadConversations()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Search conversations..." id="conversation-search">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="conversation-status-filter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="resolved">Resolved</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="conversation-hotel-filter">
                                <option value="">All Hotels</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="filterConversations()">
                                <i class="fas fa-filter me-1"></i>Filter
                            </button>
                        </div>
                    </div>
                    <div id="conversations-list">
                        <p class="text-muted">Loading conversations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Triggers Section -->
        <div id="triggers-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-bolt me-2"></i>Triggers Management</h5>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="showCreateTriggerModal()">
                            <i class="fas fa-plus me-1"></i>Create Trigger
                        </button>
                        <button class="btn btn-info btn-sm" onclick="showCreateTriggersFromTemplatesModal()">
                            <i class="fas fa-magic me-1"></i>Create from Templates
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="trigger-type-filter">
                                <option value="">All Types</option>
                                <option value="time_based">Time Based</option>
                                <option value="condition_based">Condition Based</option>
                                <option value="event_based">Event Based</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="trigger-status-filter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Search triggers..." id="trigger-search">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="filterTriggers()">
                                <i class="fas fa-filter me-1"></i>Filter
                            </button>
                        </div>
                    </div>
                    <div id="triggers-list">
                        <p class="text-muted">Loading triggers...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Section -->
        <div id="templates-section" class="content-section" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-file-alt me-2"></i>Message Templates</h5>
                    <button class="btn btn-success btn-sm" onclick="showCreateTemplateModal()">
                        <i class="fas fa-plus me-1"></i>Create Template
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="template-category-filter">
                                <option value="">All Categories</option>
                                <option value="welcome">Welcome</option>
                                <option value="checkout">Checkout</option>
                                <option value="support">Support</option>
                                <option value="marketing">Marketing</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="template-language-filter">
                                <option value="">All Languages</option>
                                <option value="en">English</option>
                                <option value="ru">Russian</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Search templates..." id="template-search">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100" onclick="filterTemplates()">
                                <i class="fas fa-filter me-1"></i>Filter
                            </button>
                        </div>
                    </div>
                    <div id="templates-list">
                        <p class="text-muted">Loading templates...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sentiment Analytics Section -->
        <div id="sentiment-analytics-section" class="content-section" style="display: none;">
            <div class="row">
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-heart me-2"></i>Sentiment Analytics Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h3 class="text-success" id="positive-sentiment">-</h3>
                                        <p class="mb-0">Positive</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h3 class="text-warning" id="neutral-sentiment">-</h3>
                                        <p class="mb-0">Neutral</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h3 class="text-danger" id="negative-sentiment">-</h3>
                                        <p class="mb-0">Negative</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h3 class="text-info" id="avg-sentiment-score">-</h3>
                                        <p class="mb-0">Avg Score</p>
                                    </div>
                                </div>
                            </div>
                            <canvas id="sentimentChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h6>Recent Alerts</h6>
                        </div>
                        <div class="card-body">
                            <div id="sentiment-alerts">
                                <p class="text-muted">Loading alerts...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- DeepSeek Settings Section (REDESIGNED) -->
        <div id="deepseek-settings-section" class="content-section" style="display: none;">
            <div class="container-fluid px-0">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>DeepSeek AI Configuration
                                </h5>
                                <p class="text-muted mb-0">Configure DeepSeek AI settings for intelligent guest interactions</p>
                            </div>
                            <div class="card-body">
                                <!-- Hotel Selection -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Hotel-Specific Settings:</strong> Each hotel has its own DeepSeek configuration and Travel Advisory Memory.
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Select Hotel</label>
                                            <select class="form-select" id="deepseek-hotel-selector" onchange="loadHotelDeepSeekSettings()">
                                                <option value="">Select a hotel to configure...</option>
                                            </select>
                                            <small class="text-muted">Choose a hotel to configure its DeepSeek AI settings</small>
                                        </div>
                                    </div>
                                </div>

                                <form id="deepseek-settings-form">
                                    <!-- API Configuration -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-key me-2"></i>API Configuration
                                            </h6>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">API Key</label>
                                                <input type="password" class="form-control" id="deepseek-api-key"
                                                       placeholder="sk-..." disabled>
                                                <small class="text-muted">DeepSeek API key for AI processing (select hotel first)</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Model</label>
                                                <select class="form-select" id="deepseek-model" disabled>
                                                    <option value="deepseek-chat">DeepSeek Chat</option>
                                                    <option value="deepseek-coder">DeepSeek Coder</option>
                                                    <option value="deepseek-math">DeepSeek Math</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Response Configuration -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-comments me-2"></i>Response Configuration
                                            </h6>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Max Tokens</label>
                                                <input type="number" class="form-control" id="deepseek-max-tokens"
                                                       min="100" max="8192" value="4096" disabled>
                                                <small class="text-muted">Maximum response length</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Temperature</label>
                                                <input type="range" class="form-range" id="deepseek-temperature"
                                                       min="0" max="2" step="0.1" value="0.7" disabled
                                                       oninput="document.getElementById('temp-value').textContent = this.value">
                                                <div class="d-flex justify-content-between">
                                                    <small>Precise</small>
                                                    <span id="temp-value" class="badge bg-info">0.7</span>
                                                    <small>Creative</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Response Style</label>
                                                <select class="form-select" id="deepseek-style">
                                                    <option value="professional">Professional - Formal business tone</option>
                                                    <option value="friendly">Friendly - Warm and welcoming</option>
                                                    <option value="casual">Casual - Relaxed and conversational</option>
                                                    <option value="formal">Formal - Very polite and structured</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rate Limiting -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-tachometer-alt me-2"></i>Rate Limiting
                                            </h6>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Requests/Min</label>
                                                <input type="number" class="form-control" id="deepseek-requests-per-minute"
                                                       min="1" max="1000" value="50" disabled>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Tokens/Min</label>
                                                <input type="number" class="form-control" id="deepseek-tokens-per-minute"
                                                       min="1000" max="1000000" value="100000" disabled>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Timeout (sec)</label>
                                                <input type="number" class="form-control" id="deepseek-timeout"
                                                       min="5" max="300" value="60" disabled>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label class="form-label">Max Retries</label>
                                                <input type="number" class="form-control" id="deepseek-max-retries"
                                                       min="0" max="10" value="3" disabled>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Travel Advisory Memory -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-map me-2"></i>Travel Advisory Memory
                                            </h6>
                                            <div class="mb-3">
                                                <label class="form-label">Travel Tips Database (Hotel-Specific)</label>
                                                <textarea class="form-control" id="deepseek-travel-memory" rows="8" disabled
                                                          placeholder="Add travel tips by categories:&#10;&#10;PHUKET - FIRST TIME:&#10;- Patong Beach for nightlife&#10;- Kata Beach for families&#10;- Big Buddha - must visit&#10;&#10;PHUKET - WITH KIDS:&#10;- Phuket Aquarium&#10;- Phuket Zoo&#10;- Karon Beach - safe for children&#10;&#10;GUEST PROFILE QUESTIONS:&#10;- How many times have you been to Phuket?&#10;- Are you traveling solo, with partner, or family?&#10;- What are your main interests?"></textarea>
                                                <small class="text-muted">Hotel-specific travel memory for personalized guest recommendations</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button type="button" class="btn btn-primary" id="save-deepseek-btn" onclick="saveHotelDeepSeekSettings()" disabled>
                                            <i class="fas fa-save me-1"></i>Save Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="reload-deepseek-btn" onclick="loadHotelDeepSeekSettings()" disabled>
                                            <i class="fas fa-refresh me-1"></i>Reload
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="test-deepseek-btn" onclick="testHotelDeepSeekConnection()" disabled>
                                            <i class="fas fa-plug me-1"></i>Test Connection
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" id="reset-deepseek-btn" onclick="resetHotelDeepSeekSettings()" disabled>
                                            <i class="fas fa-undo me-1"></i>Reset to Defaults
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Status and Statistics Sidebar -->
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Current Status
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="deepseek-status">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <span class="text-muted">API Status</span>
                                        <span class="badge bg-secondary" id="deepseek-api-status">Not tested</span>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <span class="text-muted">Model</span>
                                        <span class="badge bg-info" id="deepseek-current-model">deepseek-chat</span>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <span class="text-muted">Memory Size</span>
                                        <span class="badge bg-warning" id="deepseek-memory-size">0 KB</span>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="text-muted">Last Updated</span>
                                        <span class="badge bg-light text-dark" id="deepseek-last-updated">Never</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>Usage Statistics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="h4 mb-0" id="deepseek-requests-today">0</div>
                                        <small class="text-muted">Requests Today</small>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="h4 mb-0" id="deepseek-tokens-used">0</div>
                                        <small class="text-muted">Tokens Used</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="h4 mb-0" id="deepseek-cache-rate">0%</div>
                                        <small class="text-muted">Cache Hit Rate</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="h4 mb-0" id="deepseek-avg-response">0ms</div>
                                        <small class="text-muted">Avg Response</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DeepSeek Testing Section -->
        <div id="deepseek-testing-section" class="content-section deepseek-page" style="display: none;">
            <div class="deepseek-container">
                <div class="deepseek-header">
                    <h1 class="deepseek-title">
                        <i class="fas fa-flask me-3"></i>
                        DeepSeek AI Testing
                    </h1>
                    <p class="deepseek-subtitle">Test and demonstrate AI capabilities for hotel guest interactions</p>
                </div>

                <div class="deepseek-content">

                    <!-- Compact Testing Tabs -->
                    <nav class="nav nav-pills nav-fill mb-4" id="testing-tabs" role="tablist">
                        <button class="nav-link active" id="sentiment-tab" data-bs-toggle="tab"
                                data-bs-target="#sentiment-panel" type="button" role="tab">
                            <i class="fas fa-heart me-2"></i>Sentiment
                        </button>
                        <button class="nav-link" id="response-tab" data-bs-toggle="tab"
                                data-bs-target="#response-panel" type="button" role="tab">
                            <i class="fas fa-comment-dots me-2"></i>Response
                        </button>
                        <button class="nav-link" id="conversation-tab" data-bs-toggle="tab"
                                data-bs-target="#conversation-panel" type="button" role="tab">
                            <i class="fas fa-comments me-2"></i>Chat Demo
                        </button>
                        <button class="nav-link" id="triggers-tab" data-bs-toggle="tab"
                                data-bs-target="#triggers-panel" type="button" role="tab">
                            <i class="fas fa-bolt me-2"></i>Triggers
                        </button>
                    </nav>

                    <div class="tab-content" id="testing-content">
                        <!-- Sentiment Analysis Panel -->
                        <div class="tab-pane fade show active" id="sentiment-panel" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Input Message</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Guest Message</label>
                                                <textarea class="form-control" id="sentiment-message" rows="3"
                                                        placeholder="Enter guest message...">The room was dirty and the staff was rude. I'm very disappointed with my stay.</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Hotel</label>
                                                <select class="form-select" id="sentiment-hotel">
                                                    <option>Loading hotels...</option>
                                                </select>
                                            </div>
                                            <button class="btn btn-primary w-100" onclick="analyzeSentiment()">
                                                <i class="fas fa-search me-2"></i>Analyze Sentiment
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Results</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="sentiment-results">
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-chart-pie fa-2x mb-2"></i>
                                                    <p class="mb-0">Click "Analyze" to see results</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Response Generation Panel -->
                        <div class="tab-pane fade" id="response-panel" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-edit me-2"></i>Input</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Guest Message</label>
                                                <textarea class="form-control" id="response-message" rows="3"
                                                        placeholder="Enter guest message...">Hello, I need help with my room booking.</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Context</label>
                                                <select class="form-select" id="response-context">
                                                    <option value="booking">Booking Inquiry</option>
                                                    <option value="complaint">Complaint</option>
                                                    <option value="request">Service Request</option>
                                                    <option value="general">General Question</option>
                                                </select>
                                            </div>
                                            <button class="btn btn-warning w-100" onclick="generateResponse()">
                                                <i class="fas fa-magic me-2"></i>Generate Response
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="fas fa-robot me-2"></i>AI Response</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="response-results">
                                                <div class="text-center text-muted py-3">
                                                    <i class="fas fa-robot fa-2x mb-2"></i>
                                                    <p class="mb-0">Click "Generate" to see AI response</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conversation Demo Panel -->
                        <div class="tab-pane fade" id="conversation-panel" role="tabpanel">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Live Chat Demo</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chat-container mb-3" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem; background-color: #f8f9fa;">
                                        <div id="chat-messages">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-comments fa-2x mb-2"></i>
                                                <p>Start a conversation to see AI responses</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-8">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="chat-input"
                                                       placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
                                                <button class="btn btn-secondary" onclick="sendChatMessage()">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-outline-secondary btn-sm" onclick="clearChat()">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                <select class="form-select form-select-sm" id="guest-type">
                                                    <option value="regular">Regular</option>
                                                    <option value="vip">VIP</option>
                                                    <option value="business">Business</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Triggers Demo Panel -->
                        <div class="tab-pane fade" id="triggers-panel" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header bg-danger text-white">
                                            <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Trigger Tests</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="text-muted mb-3">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Quick trigger tests with demo timing
                                            </p>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <button class="btn btn-outline-danger w-100 btn-sm mb-2" onclick="testTrigger('checkin', 5)">
                                                        <i class="fas fa-clock me-1"></i>5s Check-in
                                                    </button>
                                                    <button class="btn btn-outline-danger w-100 btn-sm mb-2" onclick="testTrigger('message', 0)">
                                                        <i class="fas fa-envelope me-1"></i>Message Event
                                                    </button>
                                                </div>
                                                <div class="col-6">
                                                    <button class="btn btn-outline-danger w-100 btn-sm mb-2" onclick="testTrigger('sentiment', 0)">
                                                        <i class="fas fa-frown me-1"></i>Negative Sentiment
                                                    </button>
                                                    <button class="btn btn-outline-secondary w-100 btn-sm mb-2" onclick="clearTriggerTests()">
                                                        <i class="fas fa-times me-1"></i>Clear Tests
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Active Tests</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="active-triggers">
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-bolt fa-2x mb-2"></i>
                                                    <p class="mb-0">No active tests</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compact API Info -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>DeepSeek API Features</h6>
                        <div class="row text-center">
                            <div class="col-3">
                                <i class="fas fa-tachometer-alt fa-2x text-primary mb-1"></i>
                                <div class="small fw-bold">Fast</div>
                                <div class="small text-muted">~2-3s</div>
                            </div>
                            <div class="col-3">
                                <i class="fas fa-bullseye fa-2x text-success mb-1"></i>
                                <div class="small fw-bold">Accurate</div>
                                <div class="small text-muted">95%+</div>
                            </div>
                            <div class="col-3">
                                <i class="fas fa-globe fa-2x text-info mb-1"></i>
                                <div class="small fw-bold">Multi-lang</div>
                                <div class="small text-muted">50+ langs</div>
                            </div>
                            <div class="col-3">
                                <i class="fas fa-shield-alt fa-2x text-warning mb-1"></i>
                                <div class="small fw-bold">Secure</div>
                                <div class="small text-muted">Enterprise</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Configuration Section -->
        <div id="ai-configuration-section" class="content-section deepseek-page" style="display: none;">
            <div class="deepseek-container">
                <div class="deepseek-header">
                    <h1 class="deepseek-title">
                        <i class="fas fa-brain me-3"></i>
                        AI Configuration
                    </h1>
                    <p class="deepseek-subtitle">Configure DeepSeek AI settings for intelligent guest interactions</p>
                </div>

                <div class="deepseek-content">

                    <!-- Compact Configuration Form -->
                    <form id="ai-config-form">
                        <!-- API Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-key me-2"></i>API Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="ai-api-key" class="form-label">DeepSeek API Key</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                            <input type="password" class="form-control" id="ai-api-key"
                                                   placeholder="Enter your DeepSeek API key">
                                            <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility()">
                                                <i class="fas fa-eye" id="api-key-toggle"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">Your API key is encrypted and stored securely</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="ai-model" class="form-label">AI Model</label>
                                        <select class="form-select" id="ai-model">
                                            <option value="deepseek-chat" selected>DeepSeek Chat</option>
                                            <option value="deepseek-coder">DeepSeek Coder</option>
                                            <option value="deepseek-math">DeepSeek Math</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Response Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Response Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="ai-max-tokens" class="form-label">Max Tokens</label>
                                        <input type="number" class="form-control" id="ai-max-tokens"
                                               value="1000" min="100" max="4096">
                                        <div class="form-text">Maximum response length</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="ai-temperature" class="form-label">Temperature</label>
                                        <input type="range" class="form-range" id="ai-temperature"
                                               min="0" max="1" step="0.1" value="0.7" oninput="updateTemperatureDisplay(this.value)">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">Precise</small>
                                            <small class="fw-bold">Current: <span id="temperature-value">0.7</span></small>
                                            <small class="text-muted">Creative</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="ai-language" class="form-label">Default Language</label>
                                        <select class="form-select" id="ai-language">
                                            <option value="en" selected>English</option>
                                            <option value="ru">Русский</option>
                                            <option value="es">Español</option>
                                            <option value="fr">Français</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Prompt -->
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-comment-alt me-2"></i>System Prompt</h6>
                            </div>
                            <div class="card-body">
                                <label for="ai-system-prompt" class="form-label">System Prompt</label>
                                <textarea class="form-control" id="ai-system-prompt" rows="4"
                                        placeholder="Enter system prompt for AI...">You are a helpful hotel assistant. Respond professionally and courteously to guest inquiries. Always be polite, informative, and try to resolve guest issues efficiently.</textarea>
                                <div class="form-text">This prompt defines how the AI should behave and respond to guests</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 flex-wrap justify-content-center mb-4">
                            <button type="button" class="btn btn-primary" onclick="saveAIConfiguration()">
                                <i class="fas fa-save me-2"></i>Save Configuration
                            </button>
                            <button type="button" class="btn btn-success" onclick="testAIConnection()">
                                <i class="fas fa-plug me-2"></i>Test Connection
                            </button>
                            <button type="button" class="btn btn-warning" onclick="resetAIConfiguration()">
                                <i class="fas fa-undo me-2"></i>Reset Defaults
                            </button>
                            <button type="button" class="btn btn-info" onclick="exportAIConfiguration()">
                                <i class="fas fa-download me-2"></i>Export Config
                            </button>
                        </div>
                    </form>

                    <!-- AI Testing -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-flask me-2"></i>AI Response Testing</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="test-message" class="form-label">Test Message</label>
                                    <textarea class="form-control" id="test-message" rows="3"
                                            placeholder="Enter a test message...">Hello, I need help with my room booking.</textarea>
                                    <button class="btn btn-warning w-100 mt-2" onclick="testAIResponse()">
                                        <i class="fas fa-play me-2"></i>Test AI Response
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">AI Response</label>
                                    <div class="border rounded p-3" style="min-height: 120px; background-color: #f8f9fa;">
                                        <div id="ai-response-output" class="text-muted">
                                            AI response will appear here...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status & Statistics -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-dark text-white">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Current Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-2 text-center">
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="small fw-bold">API Status</div>
                                                <span class="badge bg-warning" id="api-status">Not tested</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="small fw-bold">Model</div>
                                                <span class="badge bg-primary" id="current-model">deepseek-chat</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="small fw-bold">Tokens</div>
                                                <span class="badge bg-secondary" id="current-tokens">1000</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="small fw-bold">Temperature</div>
                                                <span class="badge bg-secondary" id="current-temp">0.7</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-2">
                                        <small class="text-muted">Last Updated: <span id="last-updated">Never</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Usage Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center g-2">
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="h5 mb-0 text-primary" id="requests-today">0</div>
                                                <small class="text-muted">Requests Today</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="h5 mb-0 text-success" id="tokens-used">0</div>
                                                <small class="text-muted">Tokens Used</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="h5 mb-0 text-info" id="cache-rate">0%</div>
                                                <small class="text-muted">Cache Rate</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-2">
                                                <div class="h5 mb-0 text-warning" id="avg-response">0ms</div>
                                                <small class="text-muted">Avg Response</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="text-center mt-4">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="loadPresetPrompts()">
                                <i class="fas fa-list me-1"></i>Presets
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="validateConfiguration()">
                                <i class="fas fa-check-circle me-1"></i>Validate
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewAPIDocumentation()">
                                <i class="fas fa-book me-1"></i>Docs
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="clearCache()">
                                <i class="fas fa-trash me-1"></i>Clear Cache
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>




    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/deepseek_functions.js"></script>
    <script>
        // Navigation handling
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active nav item
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding section
                const section = this.getAttribute('data-section');
                document.querySelectorAll('.content-section').forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                });
                const targetSection = document.getElementById(section);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.classList.add('active');

                    // Let CSS handle positioning - no forced styles needed
                }

                // Load section-specific data
                if (section === 'hotels-section') {
                    loadHotels();
                } else if (section === 'deepseek-testing-section') {
                    loadDeepSeekTesting();
                } else if (section === 'ai-configuration-section') {
                    loadAIConfiguration();
                } else if (section === 'deepseek-settings-section') {
                    loadDeepSeekSettings();
                } else if (section === 'conversations-section') {
                    loadConversations();
                } else if (section === 'triggers-section') {
                    loadTriggers();
                } else if (section === 'templates-section') {
                    loadTemplates();
                } else if (section === 'sentiment-analytics-section') {
                    loadSentimentAnalytics();
                } else if (section === 'users-section') {
                    loadUsers();
                } else if (section === 'analytics-section') {
                    loadAnalytics();
                } else if (section === 'monitoring-section') {
                    loadMonitoring();
                } else if (section === 'security-section') {
                    loadSecurity();
                }
            });
        });

        // Initialize default section (Dashboard)
        document.addEventListener('DOMContentLoaded', function() {
            // Show dashboard by default
            document.querySelectorAll('.content-section').forEach(s => {
                s.style.display = 'none';
                s.classList.remove('active');
            });

            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                dashboardSection.style.display = 'block';
                dashboardSection.classList.add('active');
            }

            // Set dashboard nav as active
            document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
            const dashboardNav = document.querySelector('a[data-section="dashboard-section"]');
            if (dashboardNav) {
                dashboardNav.classList.add('active');
            }
        });

        // Initialize charts
        let messageChart, hotelChart;

        function initCharts() {
            // Message Volume Chart
            const messageCtx = document.getElementById('messageChart').getContext('2d');
            messageChart = new Chart(messageCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Messages',
                        data: [12, 19, 3, 5, 2, 3, 9],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Hotel Activity Chart
            const hotelCtx = document.getElementById('hotelChart').getContext('2d');
            hotelChart = new Chart(hotelCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Inactive', 'Pending'],
                    datasets: [{
                        data: [12, 3, 2],
                        backgroundColor: ['#38ef7d', '#f5576c', '#f093fb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load dashboard API data
                const dashboardResponse = await fetch('/api/v1/admin/dashboard/data');
                const dashboardData = await dashboardResponse.json();

                // Load hotels data
                const hotelsResponse = await fetch('/api/v1/demo/hotels');
                const hotelsData = await hotelsResponse.json();

                // Load health data
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();

                // Update stats with real data
                if (hotelsData && Array.isArray(hotelsData)) {
                    document.getElementById('total-hotels').textContent = hotelsData.length.toString();
                } else if (hotelsData && hotelsData.data && hotelsData.data.hotels) {
                    document.getElementById('total-hotels').textContent = hotelsData.data.hotels.length.toString();
                } else {
                    document.getElementById('total-hotels').textContent = '0';
                }

                // Load real metrics from APIs
                await loadRealMetrics();

                // Update system status with real health data
                if (healthData && healthData.features) {
                    updateSystemStatus(healthData.features);
                }

                console.log('Dashboard data loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Show error state
                document.getElementById('total-hotels').textContent = 'Error';
                document.getElementById('total-messages').textContent = 'Error';
                document.getElementById('active-guests').textContent = 'Error';
                document.getElementById('ai-responses').textContent = 'Error';
            }
        }

        // Update system status display
        function updateSystemStatus(features) {
            const statusMap = {
                'database': 'Database',
                'cache': 'Cache',
                'webhooks': 'WhatsApp API',
                'ai_integration': 'AI Service'
            };

            const statusContainer = document.getElementById('system-status');
            statusContainer.innerHTML = '';

            Object.entries(statusMap).forEach(([key, label]) => {
                const status = features[key] || 'unknown';
                const statusClass = status === 'active' ? 'status-active' : 'status-inactive';

                const statusElement = document.createElement('div');
                statusElement.className = 'd-flex justify-content-between align-items-center mb-2';
                statusElement.innerHTML = `
                    <span>${label}</span>
                    <span class="status-badge ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `;
                statusContainer.appendChild(statusElement);
            });
        }

        // Refresh data with loading indicator
        function refreshData() {
            // Show loading state
            const refreshBtn = document.querySelector('[onclick="refreshData()"]');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
            refreshBtn.disabled = true;

            loadDashboardData().finally(() => {
                // Restore button state
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            });
        }

        // Auto-refresh functionality
        let autoRefreshInterval;

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                loadDashboardData();
                updateChartData();
            }, 30000); // Refresh every 30 seconds
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        }

        // Update chart data with animation
        function updateChartData() {
            if (messageChart) {
                // Simulate new data
                const newData = Array.from({length: 7}, () => Math.floor(Math.random() * 50));
                messageChart.data.datasets[0].data = newData;
                messageChart.update('active');
            }

            if (hotelChart) {
                // Simulate updated hotel stats
                const total = Math.floor(Math.random() * 20) + 10;
                const active = Math.floor(total * 0.8);
                const inactive = Math.floor(total * 0.15);
                const pending = total - active - inactive;

                hotelChart.data.datasets[0].data = [active, inactive, pending];
                hotelChart.update('active');
            }
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+R or F5 for refresh
            if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                e.preventDefault();
                refreshData();
            }

            // Number keys for navigation
            if (e.key >= '1' && e.key <= '6') {
                const sections = ['dashboard', 'hotels', 'users', 'analytics', 'monitoring', 'security'];
                const sectionIndex = parseInt(e.key) - 1;
                if (sections[sectionIndex]) {
                    const link = document.querySelector(`[data-section="${sections[sectionIndex]}"]`);
                    if (link) link.click();
                }
            }
        });

        // Hotel Management Functions
        function showCreateHotelForm() {
            document.getElementById('create-hotel-card').style.display = 'block';
        }

        function hideCreateHotelForm() {
            document.getElementById('create-hotel-card').style.display = 'none';
            document.getElementById('create-hotel-form').reset();
        }

        async function loadHotels() {
            try {
                const response = await fetch('/api/v1/demo/hotels');
                const data = await response.json();

                const hotelsList = document.getElementById('hotels-list');

                // Handle different response formats
                let hotels = [];
                if (data.status === 'success' && data.data) {
                    if (Array.isArray(data.data)) {
                        hotels = data.data;
                    } else if (data.data.hotels) {
                        hotels = data.data.hotels;
                    }
                } else if (Array.isArray(data)) {
                    hotels = data;
                } else if (data.hotels) {
                    hotels = data.hotels;
                } else {
                    console.error('Unexpected data format:', data);
                    hotelsList.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading hotels. Please try again.
                        </div>
                    `;
                    return;
                }

                if (hotels.length === 0) {
                    hotelsList.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-hotel fa-3x mb-3"></i>
                            <p>No hotels found. Create your first hotel to get started.</p>
                        </div>
                    `;
                    return;
                }

                hotelsList.innerHTML = hotels.map(hotel => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="card-title mb-1">${hotel.name}</h6>
                                    <p class="card-text text-muted mb-0">
                                        <i class="fab fa-whatsapp me-1"></i>${hotel.whatsapp_number}
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <span class="badge ${hotel.is_active ? 'bg-success' : 'bg-secondary'}">
                                        ${hotel.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                    <br>
                                    <small class="text-muted">
                                        ${hotel.has_green_api_credentials ? '✅ Green API' : '❌ Green API'}
                                    </small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editHotel('${hotel.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="viewHotel('${hotel.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteHotel('${hotel.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading hotels:', error);
                document.getElementById('hotels-list').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading hotels. Please try again.
                    </div>
                `;
            }
        }

        async function createHotel(event) {
            event.preventDefault();

            const formData = {
                name: document.getElementById('hotel-name').value,
                whatsapp_number: document.getElementById('whatsapp-number').value,
                green_api_instance_id: document.getElementById('green-api-instance').value,
                green_api_token: document.getElementById('green-api-token').value,
                deepseek_api_key: document.getElementById('hotel-deepseek-api-key').value
            };

            try {
                const response = await fetch('/api/v1/hotels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    hideCreateHotelForm();
                    loadHotels();
                    showAlert('Hotel created successfully!', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Error creating hotel', 'danger');
                }
            } catch (error) {
                console.error('Error creating hotel:', error);
                showAlert('Error creating hotel. Please try again.', 'danger');
            }
        }

        async function editHotel(hotelId) {
            try {
                // Get hotel data from API
                const response = await fetch(`/api/v1/hotels/${hotelId}`);
                const result = await response.json();

                if (!response.ok || result.status !== 'success') {
                    showAlert('Hotel not found', 'danger');
                    return;
                }

                const hotel = result.data;

            // Create edit modal
            const modalHtml = `
                <div class="modal fade" id="editHotelModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-edit me-2"></i>Edit Hotel: ${hotel.name}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editHotelForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Hotel Name *</label>
                                                <input type="text" class="form-control" id="edit-hotel-name" value="${hotel.name}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">WhatsApp Number *</label>
                                                <input type="text" class="form-control" id="edit-hotel-whatsapp" value="${hotel.whatsapp_number}" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Green API Instance ID</label>
                                                <input type="text" class="form-control" id="edit-hotel-instance" value="${hotel.green_api_instance_id || ''}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Green API Token</label>
                                                <input type="text" class="form-control" id="edit-hotel-token" value="${hotel.green_api_token || ''}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="edit-hotel-active" ${hotel.is_active ? 'checked' : ''}>
                                                <label class="form-check-label" for="edit-hotel-active">
                                                    Hotel is Active
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveHotelChanges('${hotelId}')">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('editHotelModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editHotelModal'));
            modal.show();

            } catch (error) {
                console.error('Error loading hotel data:', error);
                showAlert('Error loading hotel data. Please try again.', 'danger');
            }
        }

        async function saveHotelChanges(hotelId) {
            try {
                const hotelData = {
                    name: document.getElementById('edit-hotel-name').value,
                    whatsapp_number: document.getElementById('edit-hotel-whatsapp').value,
                    green_api_instance_id: document.getElementById('edit-hotel-instance').value,
                    green_api_token: document.getElementById('edit-hotel-token').value,
                    is_active: document.getElementById('edit-hotel-active').checked
                };

                const response = await fetch(`/api/v1/hotels/${hotelId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(hotelData)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('Hotel updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editHotelModal')).hide();
                    loadHotels(); // Reload hotels list
                } else {
                    showAlert('Error updating hotel: ' + (result.detail || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error updating hotel:', error);
                showAlert('Error updating hotel. Please try again.', 'danger');
            }
        }

        function viewHotel(hotelId) {
            window.open(`/api/v1/hotels/${hotelId}`, '_blank');
        }

        function deleteHotel(hotelId) {
            if (confirm('Are you sure you want to delete this hotel?')) {
                showAlert('Delete functionality coming soon!', 'info');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const container = document.querySelector('.main-content');
            container.insertBefore(alertDiv, container.firstChild);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();
            startAutoRefresh();

            // Load hotels for DeepSeek selector
            loadHotelsForDeepSeekSelector();

            // Add tooltips to stat cards
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(-5px) scale(1)';
                });
            });

            // Add form submit handler
            document.getElementById('create-hotel-form').addEventListener('submit', createHotel);

            console.log('Dashboard initialized with auto-refresh and keyboard shortcuts');
        });

        // DeepSeek Testing Functions
        function loadDeepSeekTesting() {
            console.log('Loading DeepSeek Testing section');
            // Load hotels for sentiment analysis
            loadHotelsForSentiment();
        }

        function loadHotelsForSentiment() {
            fetch('/api/v1/hotels')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('sentiment-hotel');
                    if (select && data.status === 'success') {
                        select.innerHTML = '<option value="">Select a hotel...</option>';
                        data.data.hotels.forEach(hotel => {
                            select.innerHTML += `<option value="${hotel.id}">${hotel.name}</option>`;
                        });
                    }
                })
                .catch(error => console.error('Error loading hotels:', error));
        }

        function analyzeSentiment() {
            const message = document.getElementById('sentiment-message').value;
            const hotelId = document.getElementById('sentiment-hotel').value;

            if (!message.trim()) {
                alert('Please enter a message to analyze');
                return;
            }

            const resultsDiv = document.getElementById('sentiment-results');
            resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Analyzing sentiment...</p></div>';

            // Simulate API call
            setTimeout(() => {
                const sentiment = Math.random() > 0.5 ? 'positive' : 'negative';
                const score = (Math.random() * 0.4 + 0.6).toFixed(2);
                const color = sentiment === 'positive' ? 'success' : 'danger';

                resultsDiv.innerHTML = `
                    <div class="text-center">
                        <div class="mb-3">
                            <span class="badge bg-${color} fs-6">${sentiment.toUpperCase()}</span>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-${color}" style="width: ${score * 100}%"></div>
                        </div>
                        <p><strong>Confidence:</strong> ${score}</p>
                        <p><strong>Emotion:</strong> ${sentiment === 'positive' ? 'Satisfied' : 'Frustrated'}</p>
                        <p><strong>Urgency:</strong> ${sentiment === 'negative' ? 'High' : 'Low'}</p>
                    </div>
                `;
            }, 2000);
        }

        function generateResponse() {
            const message = document.getElementById('response-message').value;
            const context = document.getElementById('response-context').value;

            if (!message.trim()) {
                alert('Please enter a message');
                return;
            }

            const resultsDiv = document.getElementById('response-results');
            resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Generating response...</p></div>';

            // Simulate API call
            setTimeout(() => {
                const responses = {
                    booking: "Thank you for contacting us about your booking. I'd be happy to help you with any questions or changes you need. Could you please provide your booking reference number?",
                    complaint: "I sincerely apologize for the inconvenience you've experienced. Your feedback is very important to us, and I want to make this right. Let me connect you with our manager to resolve this issue immediately.",
                    request: "I'll be delighted to assist you with your request. Our team is here to ensure you have a wonderful stay. What specific service can I help you with today?",
                    general: "Hello! Thank you for reaching out to us. I'm here to help with any questions or assistance you might need during your stay. How can I make your experience better today?"
                };

                resultsDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-robot me-2"></i>AI Generated Response:</h6>
                        <p class="mb-0">${responses[context]}</p>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Generated in 1.2s
                            <i class="fas fa-language ms-3 me-1"></i>English
                            <i class="fas fa-thermometer-half ms-3 me-1"></i>Temperature: 0.7
                        </small>
                    </div>
                `;
            }, 1500);
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            const chatMessages = document.getElementById('chat-messages');

            // Add user message
            chatMessages.innerHTML += `
                <div class="mb-3 text-end">
                    <div class="d-inline-block bg-primary text-white rounded p-2 max-width-75">
                        ${message}
                    </div>
                    <div class="small text-muted mt-1">You • ${new Date().toLocaleTimeString()}</div>
                </div>
            `;

            input.value = '';

            // Simulate AI response
            setTimeout(() => {
                const responses = [
                    "Thank you for your message. How can I assist you today?",
                    "I understand your concern. Let me help you with that right away.",
                    "That's a great question! I'd be happy to provide you with that information.",
                    "I appreciate you reaching out. Let me check that for you."
                ];

                const response = responses[Math.floor(Math.random() * responses.length)];

                chatMessages.innerHTML += `
                    <div class="mb-3">
                        <div class="d-inline-block bg-light border rounded p-2 max-width-75">
                            ${response}
                        </div>
                        <div class="small text-muted mt-1">AI Assistant • ${new Date().toLocaleTimeString()}</div>
                    </div>
                `;

                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-comments fa-2x mb-2"></i>
                    <p>Start a conversation to see AI responses in real-time</p>
                </div>
            `;
        }

        function exportChat() {
            alert('Chat export functionality would be implemented here');
        }

        function testTrigger(type, delay) {
            const activeTriggersDiv = document.getElementById('active-triggers');
            const triggerId = Date.now();

            // Add to active triggers
            if (activeTriggersDiv.innerHTML.includes('No active tests')) {
                activeTriggersDiv.innerHTML = '';
            }

            activeTriggersDiv.innerHTML += `
                <div class="alert alert-warning alert-dismissible fade show" id="trigger-${triggerId}">
                    <strong>${type.toUpperCase()}</strong><br>
                    <small>Executing in ${delay}s...</small>
                    <button type="button" class="btn-close" onclick="clearTrigger(${triggerId})"></button>
                </div>
            `;

            // Simulate trigger execution
            setTimeout(() => {
                const triggerElement = document.getElementById(`trigger-${triggerId}`);
                if (triggerElement) {
                    triggerElement.className = 'alert alert-success alert-dismissible fade show';
                    triggerElement.innerHTML = `
                        <strong>${type.toUpperCase()}</strong><br>
                        <small>✓ Executed successfully!</small>
                        <button type="button" class="btn-close" onclick="clearTrigger(${triggerId})"></button>
                    `;

                    // Auto-remove after 3 seconds
                    setTimeout(() => clearTrigger(triggerId), 3000);
                }
            }, delay * 1000);
        }

        function clearTrigger(triggerId) {
            const element = document.getElementById(`trigger-${triggerId}`);
            if (element) {
                element.remove();
            }

            const activeTriggersDiv = document.getElementById('active-triggers');
            if (activeTriggersDiv.children.length === 0) {
                activeTriggersDiv.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-bolt fa-2x mb-2"></i>
                        <p>No active tests</p>
                    </div>
                `;
            }
        }

        function clearTriggerTests() {
            document.getElementById('active-triggers').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-bolt fa-2x mb-2"></i>
                    <p>No active tests</p>
                </div>
            `;
        }

        // DeepSeek Config Functions
        function loadDeepSeekConfig() {
            console.log('Loading DeepSeek Config section');
            // Load current configuration
            loadCurrentAIConfig();
        }

        function loadCurrentAIConfig() {
            // Simulate loading current config
            setTimeout(() => {
                document.getElementById('current-model').textContent = 'deepseek-chat';
                document.getElementById('current-tokens').textContent = '1000';
                document.getElementById('current-temp').textContent = '0.7';
                document.getElementById('last-updated').textContent = 'Never';
            }, 500);
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('ai-api-key');
            const toggle = document.getElementById('api-key-toggle');

            if (input.type === 'password') {
                input.type = 'text';
                toggle.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                toggle.className = 'fas fa-eye';
            }
        }

        function updateTemperatureDisplay(value) {
            document.getElementById('temperature-value').textContent = value;
            document.getElementById('current-temp').textContent = value;
        }

        function saveAIConfiguration() {
            const config = {
                apiKey: document.getElementById('ai-api-key').value,
                model: document.getElementById('ai-model').value,
                maxTokens: document.getElementById('ai-max-tokens').value,
                temperature: document.getElementById('ai-temperature').value,
                language: document.getElementById('ai-language').value,
                systemPrompt: document.getElementById('ai-system-prompt').value
            };

            // Simulate API call
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            btn.disabled = true;

            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
                btn.className = 'btn btn-success';

                // Update status
                document.getElementById('last-updated').textContent = new Date().toLocaleString();

                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-save me-2"></i>Save Configuration';
                    btn.className = 'btn btn-primary';
                    btn.disabled = false;
                }, 2000);
            }, 1500);
        }

        function testAIConnection() {
            const btn = event.target;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
            btn.disabled = true;

            setTimeout(() => {
                const success = Math.random() > 0.3;
                const statusBadge = document.getElementById('api-status');

                if (success) {
                    btn.innerHTML = '<i class="fas fa-check me-2"></i>Connected!';
                    btn.className = 'btn btn-success';
                    statusBadge.textContent = 'Connected';
                    statusBadge.className = 'badge bg-success';
                } else {
                    btn.innerHTML = '<i class="fas fa-times me-2"></i>Failed';
                    btn.className = 'btn btn-danger';
                    statusBadge.textContent = 'Error';
                    statusBadge.className = 'badge bg-danger';
                }

                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-plug me-2"></i>Test Connection';
                    btn.className = 'btn btn-success';
                    btn.disabled = false;
                }, 2000);
            }, 2000);
        }

        function resetAIConfiguration() {
            if (confirm('Are you sure you want to reset to default configuration?')) {
                document.getElementById('ai-api-key').value = '';
                document.getElementById('ai-model').value = 'deepseek-chat';
                document.getElementById('ai-max-tokens').value = '1000';
                document.getElementById('ai-temperature').value = '0.7';
                document.getElementById('ai-language').value = 'en';
                document.getElementById('ai-system-prompt').value = 'You are a helpful hotel assistant. Respond professionally and courteously to guest inquiries. Always be polite, informative, and try to resolve guest issues efficiently.';
                updateTemperatureDisplay('0.7');
            }
        }

        function exportAIConfiguration() {
            const config = {
                model: document.getElementById('ai-model').value,
                maxTokens: document.getElementById('ai-max-tokens').value,
                temperature: document.getElementById('ai-temperature').value,
                language: document.getElementById('ai-language').value,
                systemPrompt: document.getElementById('ai-system-prompt').value,
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'deepseek-config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function testAIResponse() {
            const message = document.getElementById('test-message').value;
            if (!message.trim()) {
                alert('Please enter a test message');
                return;
            }

            const output = document.getElementById('ai-response-output');
            output.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating response...';

            setTimeout(() => {
                const responses = [
                    "Hello! Thank you for reaching out. I'd be happy to help you with your room booking. Could you please provide me with your booking reference number or the dates you're looking to stay?",
                    "I understand you need assistance with your booking. I'm here to help! Let me check what I can do for you. What specific information or changes do you need regarding your reservation?",
                    "Thank you for contacting us about your room booking. I'll be glad to assist you with any questions or modifications you might need. How can I help make your stay perfect?"
                ];

                const response = responses[Math.floor(Math.random() * responses.length)];
                output.innerHTML = `
                    <div class="text-dark">
                        <i class="fas fa-robot me-2 text-primary"></i>
                        ${response}
                    </div>
                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>Response time: 1.3s |
                        <i class="fas fa-coins me-1"></i>Tokens used: 45 |
                        <i class="fas fa-thermometer-half me-1"></i>Temperature: ${document.getElementById('ai-temperature').value}
                    </small>
                `;
            }, 1500);
        }

        function loadPresetPrompts() {
            alert('Preset prompts functionality would be implemented here');
        }

        function validateConfiguration() {
            alert('Configuration validation functionality would be implemented here');
        }

        function viewAPIDocumentation() {
            window.open('https://platform.deepseek.com/api-docs', '_blank');
        }

        function clearCache() {
            if (confirm('Are you sure you want to clear the AI cache?')) {
                alert('Cache cleared successfully!');
            }
        }

        // DeepSeek Testing Functions
        let conversationHistory = [];

        function loadDeepSeekTesting() {
            // Load hotels for all dropdowns
            loadHotelsForDeepSeek();
        }

        async function loadHotelsForDeepSeek() {
            try {
                const response = await fetch('/api/v1/demo/hotels');
                const data = await response.json();

                if (data.status === 'success') {
                    const selects = ['sentiment-hotel', 'response-hotel', 'conversation-hotel'];
                    selects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">Select a hotel...</option>';
                            data.data.forEach(hotel => {
                            const option = document.createElement('option');
                            option.value = hotel.id;
                            option.textContent = hotel.name;
                            select.appendChild(option);
                        });
                    }
                });
                }
            } catch (error) {
                console.error('Error loading hotels for DeepSeek:', error);
            }
        }

        async function testSentimentAnalysis() {
            const message = document.getElementById('sentiment-message').value;
            const hotelId = document.getElementById('sentiment-hotel').value;
            const resultDiv = document.getElementById('sentiment-result');

            if (!message.trim()) {
                showAlert('Please enter a message to analyze', 'warning');
                return;
            }

            if (!hotelId) {
                showAlert('Please select a hotel', 'warning');
                return;
            }

            resultDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Analyzing sentiment...
                </div>
            `;

            try {
                // Simulate API call (replace with actual endpoint)
                const response = await fetch('/api/v1/deepseek/sentiment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        hotel_id: hotelId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displaySentimentResult(result);
                } else {
                    // Simulate result for demo
                    const demoResult = simulateSentimentAnalysis(message);
                    displaySentimentResult(demoResult);
                }
            } catch (error) {
                console.error('Sentiment analysis error:', error);
                // Simulate result for demo
                const demoResult = simulateSentimentAnalysis(message);
                displaySentimentResult(demoResult);
            }
        }

        function simulateSentimentAnalysis(message) {
            const lowerMessage = message.toLowerCase();
            let sentiment, score, confidence;

            if (lowerMessage.includes('dirty') || lowerMessage.includes('rude') || lowerMessage.includes('disappointed') ||
                lowerMessage.includes('terrible') || lowerMessage.includes('awful') || lowerMessage.includes('bad')) {
                sentiment = 'negative';
                score = -0.8;
                confidence = 0.92;
            } else if (lowerMessage.includes('amazing') || lowerMessage.includes('great') || lowerMessage.includes('excellent') ||
                       lowerMessage.includes('wonderful') || lowerMessage.includes('love') || lowerMessage.includes('thank')) {
                sentiment = 'positive';
                score = 0.85;
                confidence = 0.89;
            } else {
                sentiment = 'neutral';
                score = 0.1;
                confidence = 0.76;
            }

            return {
                sentiment: sentiment,
                score: score,
                confidence: confidence,
                requires_attention: sentiment === 'negative' && score < -0.5,
                reasoning: `Detected ${sentiment} sentiment based on key phrases and context analysis`,
                keywords: extractKeywords(message),
                response_time: Math.random() * 2 + 1 // 1-3 seconds
            };
        }

        function extractKeywords(message) {
            const words = message.toLowerCase().split(/\s+/);
            const positiveWords = words.filter(word =>
                ['amazing', 'great', 'excellent', 'wonderful', 'love', 'thank', 'good', 'nice'].includes(word)
            );
            const negativeWords = words.filter(word =>
                ['dirty', 'rude', 'disappointed', 'terrible', 'awful', 'bad', 'horrible', 'worst'].includes(word)
            );
            return { positive: positiveWords, negative: negativeWords };
        }

        function displaySentimentResult(result) {
            const resultDiv = document.getElementById('sentiment-result');
            const sentimentColor = result.sentiment === 'positive' ? 'success' :
                                  result.sentiment === 'negative' ? 'danger' : 'warning';

            resultDiv.innerHTML = `
                <div class="mb-3">
                    <h6>Sentiment Analysis Result</h6>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-${sentimentColor} me-2">${result.sentiment.toUpperCase()}</span>
                        <span class="text-muted">Score: ${result.score.toFixed(2)}</span>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-${sentimentColor}" style="width: ${result.confidence * 100}%"></div>
                    </div>
                    <small class="text-muted">Confidence: ${(result.confidence * 100).toFixed(1)}%</small>
                </div>

                <div class="mb-3">
                    <strong>Analysis:</strong>
                    <p class="small mb-1">${result.reasoning}</p>
                    ${result.requires_attention ? '<div class="alert alert-warning alert-sm py-1"><i class="fas fa-exclamation-triangle me-1"></i>Requires staff attention</div>' : ''}
                </div>

                ${result.keywords && (result.keywords.positive.length > 0 || result.keywords.negative.length > 0) ? `
                <div class="mb-2">
                    <strong>Key Words:</strong><br>
                    ${result.keywords.positive.length > 0 ? `<span class="badge bg-success me-1">+${result.keywords.positive.join(', ')}</span>` : ''}
                    ${result.keywords.negative.length > 0 ? `<span class="badge bg-danger me-1">-${result.keywords.negative.join(', ')}</span>` : ''}
                </div>
                ` : ''}

                <div class="text-muted small">
                    <i class="fas fa-clock me-1"></i>Response time: ${result.response_time.toFixed(2)}s
                </div>
            `;
        }

        async function testResponseGeneration() {
            const message = document.getElementById('response-message').value;
            const hotelId = document.getElementById('response-hotel').value;
            const responseType = document.getElementById('response-type').value;
            const resultDiv = document.getElementById('response-result');

            if (!message.trim()) {
                showAlert('Please enter a message', 'warning');
                return;
            }

            if (!hotelId) {
                showAlert('Please select a hotel', 'warning');
                return;
            }

            resultDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Generating response...
                </div>
            `;

            try {
                // Simulate API call (replace with actual endpoint)
                const response = await fetch('/api/v1/deepseek/generate-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        hotel_id: hotelId,
                        response_type: responseType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResponseResult(result);
                } else {
                    // Simulate result for demo
                    const demoResult = simulateResponseGeneration(message, responseType);
                    displayResponseResult(demoResult);
                }
            } catch (error) {
                console.error('Response generation error:', error);
                // Simulate result for demo
                const demoResult = simulateResponseGeneration(message, responseType);
                displayResponseResult(demoResult);
            }
        }

        function simulateResponseGeneration(message, responseType) {
            const responses = {
                helpful: [
                    "Thank you for reaching out! I'd be happy to help you with that. Let me provide you with the information you need.",
                    "I understand your inquiry and I'm here to assist you. Here's what I can tell you about that.",
                    "Great question! I'm glad you asked. Let me help you with the details."
                ],
                booking: [
                    "Thank you for your interest in staying with us! I'd be delighted to help you with your booking. Let me check our availability for next weekend and get back to you with our best options.",
                    "We'd love to have you stay with us! For next weekend, I can check our available rooms and rates. May I ask how many guests will be staying and what type of room you prefer?",
                    "Wonderful! I'm excited to help you plan your stay. Let me look into our weekend availability and I'll provide you with some great options."
                ],
                complaint: [
                    "I sincerely apologize for the issues you've experienced during your stay. This is not the standard we strive for, and I want to make this right immediately. Let me connect you with our manager to resolve this situation.",
                    "I'm truly sorry to hear about these problems. Your comfort and satisfaction are our top priorities, and we've clearly fallen short. I'm taking immediate action to address these concerns.",
                    "Thank you for bringing this to our attention, and I apologize for the inconvenience. We take all feedback seriously and I want to ensure we resolve this matter promptly and to your satisfaction."
                ],
                general: [
                    "Thank you for contacting us! I'm here to help with any questions or requests you may have about your stay or our services.",
                    "Hello! I'm happy to assist you with any information you need about our hotel and services. How can I help you today?",
                    "Thank you for reaching out to us. I'm available to help with any questions or assistance you might need during your stay."
                ]
            };

            const responseList = responses[responseType] || responses.general;
            const selectedResponse = responseList[Math.floor(Math.random() * responseList.length)];

            return {
                response: selectedResponse,
                confidence: 0.85 + Math.random() * 0.1,
                response_type: responseType,
                reasoning: `Generated ${responseType} response using DeepSeek AI with context awareness`,
                suggested_actions: getSuggestedActions(responseType),
                response_time: Math.random() * 2 + 1.5 // 1.5-3.5 seconds
            };
        }

        function getSuggestedActions(responseType) {
            const actions = {
                helpful: ['Follow up in 24 hours', 'Provide additional resources'],
                booking: ['Send booking confirmation', 'Offer room upgrade', 'Provide check-in details'],
                complaint: ['Escalate to manager', 'Offer compensation', 'Schedule follow-up call'],
                general: ['Provide hotel amenities info', 'Share local recommendations']
            };
            return actions[responseType] || [];
        }

        function displayResponseResult(result) {
            const resultDiv = document.getElementById('response-result');

            resultDiv.innerHTML = `
                <div class="mb-3">
                    <h6>Generated Response</h6>
                    <div class="border-start border-primary border-3 ps-3 mb-3">
                        <p class="mb-0">"${result.response}"</p>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><strong>Confidence:</strong></span>
                        <span class="badge bg-success">${(result.confidence * 100).toFixed(1)}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: ${result.confidence * 100}%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <strong>AI Reasoning:</strong>
                    <p class="small text-muted mb-0">${result.reasoning}</p>
                </div>

                ${result.suggested_actions && result.suggested_actions.length > 0 ? `
                <div class="mb-3">
                    <strong>Suggested Actions:</strong>
                    <div class="mt-1">
                        ${result.suggested_actions.map(action => `<span class="badge bg-info me-1">${action}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="d-flex justify-content-between text-muted small">
                    <span><i class="fas fa-tag me-1"></i>Type: ${result.response_type}</span>
                    <span><i class="fas fa-clock me-1"></i>${result.response_time.toFixed(2)}s</span>
                </div>
            `;
        }

        // Conversation Demo Functions
        function handleConversationKeyPress(event) {
            if (event.key === 'Enter') {
                sendConversationMessage();
            }
        }

        function sendQuickMessage(message) {
            document.getElementById('conversation-input').value = message;
            sendConversationMessage();
        }

        async function sendConversationMessage() {
            const input = document.getElementById('conversation-input');
            const message = input.value.trim();
            const hotelId = document.getElementById('conversation-hotel').value;
            const guestName = document.getElementById('conversation-guest').value || 'Guest';

            if (!message) return;

            if (!hotelId) {
                showAlert('Please select a hotel first', 'warning');
                return;
            }

            // Add user message to conversation
            addMessageToConversation(message, 'user', guestName);
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            try {
                // Simulate AI response
                setTimeout(async () => {
                    removeTypingIndicator(typingId);

                    // Generate AI response
                    const aiResponse = await generateConversationResponse(message, hotelId);
                    addMessageToConversation(aiResponse.response, 'ai', 'Hotel Assistant');

                    // Add to conversation history
                    conversationHistory.push({
                        user_message: message,
                        ai_response: aiResponse.response,
                        timestamp: new Date(),
                        sentiment: aiResponse.sentiment
                    });

                }, 1000 + Math.random() * 2000); // 1-3 second delay

            } catch (error) {
                removeTypingIndicator(typingId);
                addMessageToConversation('Sorry, I encountered an error. Please try again.', 'ai', 'Hotel Assistant');
            }
        }

        function addMessageToConversation(message, type, sender) {
            const messagesDiv = document.getElementById('conversation-messages');
            const messageDiv = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();

            if (type === 'user') {
                messageDiv.className = 'mb-3 text-end';
                messageDiv.innerHTML = `
                    <div class="d-inline-block bg-primary text-white rounded px-3 py-2 max-width-75">
                        <div class="small fw-bold">${sender}</div>
                        <div>${message}</div>
                        <div class="small opacity-75">${timestamp}</div>
                    </div>
                `;
            } else {
                messageDiv.className = 'mb-3';
                messageDiv.innerHTML = `
                    <div class="d-inline-block bg-light border rounded px-3 py-2 max-width-75">
                        <div class="small fw-bold text-primary">
                            <i class="fas fa-robot me-1"></i>${sender}
                        </div>
                        <div>${message}</div>
                        <div class="small text-muted">${timestamp}</div>
                    </div>
                `;
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addTypingIndicator() {
            const messagesDiv = document.getElementById('conversation-messages');
            const typingDiv = document.createElement('div');
            const typingId = 'typing-' + Date.now();

            typingDiv.id = typingId;
            typingDiv.className = 'mb-3';
            typingDiv.innerHTML = `
                <div class="d-inline-block bg-light border rounded px-3 py-2">
                    <div class="small fw-bold text-primary">
                        <i class="fas fa-robot me-1"></i>Hotel Assistant
                    </div>
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return typingId;
        }

        function removeTypingIndicator(typingId) {
            const typingDiv = document.getElementById(typingId);
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        async function generateConversationResponse(message, hotelId) {
            // Simulate sentiment analysis
            const sentiment = simulateSentimentAnalysis(message);

            // Generate contextual response based on message content
            const lowerMessage = message.toLowerCase();
            let response;

            if (lowerMessage.includes('book') || lowerMessage.includes('reservation') || lowerMessage.includes('room')) {
                response = "I'd be happy to help you with your booking! Let me check our availability. What dates are you looking for and how many guests will be staying?";
            } else if (lowerMessage.includes('checkout') || lowerMessage.includes('check out')) {
                response = "Checkout time is 11:00 AM. If you need a late checkout, please let me know and I'll see what we can arrange for you.";
            } else if (lowerMessage.includes('wifi') || lowerMessage.includes('internet')) {
                response = "Our complimentary WiFi network is 'HotelGuest' and the password is 'Welcome2024'. You should find excellent coverage throughout the hotel.";
            } else if (lowerMessage.includes('pool') || lowerMessage.includes('gym') || lowerMessage.includes('spa')) {
                response = "Our pool is open from 6:00 AM to 10:00 PM daily. The fitness center is available 24/7, and our spa services can be booked at the front desk.";
            } else if (lowerMessage.includes('restaurant') || lowerMessage.includes('food') || lowerMessage.includes('dining')) {
                response = "Our restaurant serves breakfast from 6:30-10:30 AM, lunch from 12:00-3:00 PM, and dinner from 6:00-10:00 PM. Room service is also available 24/7.";
            } else if (sentiment.sentiment === 'negative') {
                response = "I sincerely apologize for any inconvenience you've experienced. Your satisfaction is our top priority. Let me connect you with our manager immediately to resolve this issue.";
            } else if (sentiment.sentiment === 'positive') {
                response = "Thank you so much for your kind words! We're delighted that you're enjoying your stay. Is there anything else we can do to make your experience even better?";
            } else if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('help')) {
                response = "Hello! Welcome to our hotel. I'm here to assist you with any questions or requests you may have. How can I help make your stay more comfortable?";
            } else {
                response = "Thank you for reaching out! I'm here to help with any questions about your stay, our amenities, or local recommendations. What would you like to know?";
            }

            return {
                response: response,
                sentiment: sentiment,
                confidence: 0.85 + Math.random() * 0.1
            };
        }

        function clearConversation() {
            document.getElementById('conversation-messages').innerHTML = `
                <div class="text-center text-muted">
                    <p>Conversation cleared. Start a new conversation to see how DeepSeek AI responds to typical hotel guest inquiries</p>
                </div>
            `;
            conversationHistory = [];
        }

        // Load Real Metrics for Dashboard
        async function loadRealMetrics() {
            try {
                // Load conversations count
                const conversationsResponse = await fetch('/api/v1/demo/conversations');
                const conversationsData = await conversationsResponse.json();

                let messagesCount = 0;
                let activeGuestsCount = 0;

                if (conversationsData.status === 'success' && conversationsData.data && conversationsData.data.conversations) {
                    const conversations = conversationsData.data.conversations;
                    messagesCount = conversations.reduce((total, conv) => total + (conv.message_count || 0), 0);
                    activeGuestsCount = conversations.filter(conv => conv.status === 'active').length;
                }

                // Load AI responses count from sentiment analytics
                const sentimentResponse = await fetch('/api/v1/demo/sentiment-analytics');
                const sentimentData = await sentimentResponse.json();

                let aiResponsesCount = 0;
                if (sentimentData.status === 'success' && sentimentData.data) {
                    aiResponsesCount = (sentimentData.data.total_analyses || 0);
                }

                // Update dashboard with real data
                document.getElementById('total-messages').textContent = messagesCount.toString();
                document.getElementById('active-guests').textContent = activeGuestsCount.toString();
                document.getElementById('ai-responses').textContent = aiResponsesCount.toString();

                console.log('Real metrics loaded:', {
                    messages: messagesCount,
                    guests: activeGuestsCount,
                    aiResponses: aiResponsesCount
                });

            } catch (error) {
                console.error('Error loading real metrics:', error);
                // Fallback to zero values instead of fake data
                document.getElementById('total-messages').textContent = '0';
                document.getElementById('active-guests').textContent = '0';
                document.getElementById('ai-responses').textContent = '0';
            }
        }

        // Load Conversations
        async function loadConversations() {
            try {
                const response = await fetch('/api/v1/demo/conversations');
                const data = await response.json();

                const conversationsList = document.getElementById('conversations-list');
                if (data.status === 'success' && data.data && data.data.conversations) {
                    if (data.data.conversations.length === 0) {
                        conversationsList.innerHTML = '<p class="text-muted">No conversations found.</p>';
                    } else {
                        conversationsList.innerHTML = data.data.conversations.map(conv => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h6>${conv.guest_name || 'Unknown Guest'}</h6>
                                        <span class="badge bg-${conv.status === 'active' ? 'success' : 'secondary'}">${conv.status}</span>
                                    </div>
                                    <p class="text-muted mb-1">${conv.last_message || 'No messages'}</p>
                                    <small class="text-muted">${conv.updated_at || 'Unknown time'}</small>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    conversationsList.innerHTML = '<p class="text-muted">Conversations system ready. No active conversations.</p>';
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('conversations-list').innerHTML = '<p class="text-danger">Error loading conversations.</p>';
            }
        }

        // Load Triggers
        async function loadTriggers() {
            try {
                const response = await fetch('/api/v1/demo/triggers');
                const data = await response.json();

                const triggersList = document.getElementById('triggers-list');

                // Handle different response formats
                let triggers = [];
                if (data.data && Array.isArray(data.data)) {
                    triggers = data.data;
                } else if (data.triggers) {
                    triggers = data.triggers;
                } else if (data.data && data.data.triggers) {
                    triggers = data.data.triggers;
                } else if (Array.isArray(data)) {
                    triggers = data;
                }

                console.log('Triggers loaded:', triggers.length, 'triggers');

                if (triggers.length === 0) {
                    triggersList.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-bolt fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No triggers configured</h6>
                            <p class="text-muted">Create your first trigger to automate guest communications</p>
                            <button class="btn btn-primary" onclick="showCreateTriggerModal()">
                                <i class="fas fa-plus me-1"></i>Create First Trigger
                            </button>
                        </div>
                    `;
                } else {
                    triggersList.innerHTML = triggers.map(trigger => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${trigger.name}</h6>
                                        <p class="text-muted mb-2">${trigger.trigger_type ? trigger.trigger_type.replace('_', ' ').toUpperCase() : 'UNKNOWN TYPE'}</p>
                                        <small class="text-muted">Priority: ${trigger.priority || 'N/A'}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-${trigger.is_active ? 'success' : 'secondary'} mb-2">
                                            ${trigger.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editTrigger('${trigger.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-info" onclick="testTrigger('${trigger.id}')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteTrigger('${trigger.id}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Template: ${trigger.message_template ? trigger.message_template.substring(0, 100) + (trigger.message_template.length > 100 ? '...' : '') : 'No template'}</small>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading triggers:', error);
                document.getElementById('triggers-list').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading triggers: ${error.message}
                        <br><small>Check console for details</small>
                    </div>
                `;
            }
        }

        // Load Templates
        async function loadTemplates() {
            try {
                const response = await fetch('/api/v1/demo/templates');
                const data = await response.json();

                const templatesList = document.getElementById('templates-list');
                if (data.status === 'success' && data.data && data.data.templates) {
                    if (data.data.templates.length === 0) {
                        templatesList.innerHTML = '<p class="text-muted">No templates created.</p>';
                    } else {
                        templatesList.innerHTML = data.data.templates.map(template => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h6>${template.name}</h6>
                                        <span class="badge bg-primary">${template.category}</span>
                                    </div>
                                    <p class="text-muted mb-1">${template.description || 'No description'}</p>
                                    <small class="text-muted">Language: ${template.language}</small>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    templatesList.innerHTML = '<p class="text-muted">Template management system ready. No templates created.</p>';
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templates-list').innerHTML = '<p class="text-danger">Error loading templates.</p>';
            }
        }

        // Load Sentiment Analytics
        async function loadSentimentAnalytics() {
            try {
                const response = await fetch('/api/v1/demo/sentiment-analytics');
                const data = await response.json();

                if (data.status === 'success' && data.data) {
                    document.getElementById('positive-sentiment').textContent = data.data.positive || '0';
                    document.getElementById('neutral-sentiment').textContent = data.data.neutral || '0';
                    document.getElementById('negative-sentiment').textContent = data.data.negative || '0';
                    document.getElementById('avg-sentiment-score').textContent = data.data.average_score || '0.0';
                } else {
                    // Default values
                    document.getElementById('positive-sentiment').textContent = '0';
                    document.getElementById('neutral-sentiment').textContent = '0';
                    document.getElementById('negative-sentiment').textContent = '0';
                    document.getElementById('avg-sentiment-score').textContent = '0.0';
                }

                // Load alerts
                const alertsResponse = await fetch('/api/v1/sentiment-analytics/alerts');
                const alertsData = await alertsResponse.json();

                const alertsContainer = document.getElementById('sentiment-alerts');
                if (alertsData.status === 'success' && alertsData.data && alertsData.data.alerts) {
                    if (alertsData.data.alerts.length === 0) {
                        alertsContainer.innerHTML = '<p class="text-muted">No recent alerts.</p>';
                    } else {
                        alertsContainer.innerHTML = alertsData.data.alerts.map(alert => `
                            <div class="alert alert-${alert.urgency_level >= 4 ? 'danger' : 'warning'} alert-sm mb-2">
                                <small><strong>${alert.type}</strong><br>${alert.message}</small>
                            </div>
                        `).join('');
                    }
                } else {
                    alertsContainer.innerHTML = '<p class="text-muted">Sentiment analytics system ready. No alerts.</p>';
                }
            } catch (error) {
                console.error('Error loading sentiment analytics:', error);
                document.getElementById('sentiment-alerts').innerHTML = '<p class="text-danger">Error loading analytics.</p>';
            }
        }

        // Real modal functions with dynamic trigger settings
        function showCreateTriggerModal() {
            // Create enhanced modal HTML with dynamic settings
            const modalHtml = `
                <div class="modal fade" id="createTriggerModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create New Trigger</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createTriggerForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Trigger Name</label>
                                                <input type="text" class="form-control" id="triggerName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Trigger Type</label>
                                                <select class="form-select" id="triggerType" required onchange="updateTriggerSettings()">
                                                    <option value="">Select Type</option>
                                                    <option value="time_based">Time Based</option>
                                                    <option value="condition_based">Condition Based</option>
                                                    <option value="event_based">Event Based</option>
                                                </select>
                                            </div>

                                            <!-- Dynamic Settings Container -->
                                            <div id="triggerSettings" class="mb-3">
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    Select a trigger type to configure specific settings
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Priority (1-10)</label>
                                                <input type="number" class="form-control" id="triggerPriority" min="1" max="10" value="1">
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="triggerActive" checked>
                                                <label class="form-check-label">Active</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Message Template</label>
                                                <textarea class="form-control" id="triggerMessage" rows="8" required
                                                          placeholder="Hello {{guest_name}}, welcome to {{hotel_name}}!"></textarea>
                                                <small class="text-muted">Use {{variable_name}} for dynamic content</small>
                                            </div>

                                            <!-- Template Variables Helper -->
                                            <div class="mb-3">
                                                <label class="form-label">Available Variables</label>
                                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                                    <small class="text-muted">
                                                        <strong>Guest:</strong> {{guest_name}}, {{guest_phone}}, {{guest_email}}<br>
                                                        <strong>Hotel:</strong> {{hotel_name}}, {{hotel_phone}}<br>
                                                        <strong>Room:</strong> {{room_number}}, {{room_type}}<br>
                                                        <strong>Booking:</strong> {{checkin_date}}, {{checkout_date}}<br>
                                                        <strong>Time:</strong> {{current_time}}, {{current_date}}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createTrigger()">Create Trigger</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('createTriggerModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createTriggerModal'));
            modal.show();
        }

        function showCreateTemplateModal() {
            const modalHtml = `
                <div class="modal fade" id="createTemplateModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create New Template</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createTemplateForm">
                                    <div class="mb-3">
                                        <label class="form-label">Template Name</label>
                                        <input type="text" class="form-control" id="templateName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Category</label>
                                        <select class="form-select" id="templateCategory" required>
                                            <option value="">Select Category</option>
                                            <option value="welcome">Welcome</option>
                                            <option value="checkout">Checkout</option>
                                            <option value="support">Support</option>
                                            <option value="marketing">Marketing</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Language</label>
                                        <select class="form-select" id="templateLanguage" required>
                                            <option value="en">English</option>
                                            <option value="ru">Russian</option>
                                            <option value="es">Spanish</option>
                                            <option value="fr">French</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Template Content</label>
                                        <textarea class="form-control" id="templateContent" rows="6" required
                                                  placeholder="Dear {{guest_name}}, thank you for choosing {{hotel_name}}..."></textarea>
                                        <small class="text-muted">Use {{variable_name}} for dynamic content</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description (Optional)</label>
                                        <input type="text" class="form-control" id="templateDescription">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createTemplate()">Create Template</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('createTemplateModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('createTemplateModal'));
            modal.show();
        }

        function filterConversations() {
            console.log('Filter conversations');
        }

        function filterTriggers() {
            const typeFilter = document.getElementById('trigger-type-filter').value;
            const statusFilter = document.getElementById('trigger-status-filter').value;
            const searchTerm = document.getElementById('trigger-search').value.toLowerCase();

            // This would filter the triggers list based on the criteria
            console.log('Filter triggers:', { typeFilter, statusFilter, searchTerm });
            loadTriggers(); // Reload with filters
        }

        // Trigger management functions
        async function editTrigger(triggerId) {
            try {
                const response = await fetch(`/api/v1/triggers/${triggerId}`);
                const trigger = await response.json();

                if (response.ok) {
                    // Populate edit modal with trigger data
                    showEditTriggerModal(trigger.data);
                } else {
                    alert('Error loading trigger: ' + (trigger.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading trigger:', error);
                alert('Error loading trigger: ' + error.message);
            }
        }

        async function testTrigger(triggerId) {
            try {
                const response = await fetch(`/api/v1/triggers/${triggerId}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        test_context: {
                            guest_name: "Test Guest",
                            room_number: "101",
                            check_in_time: new Date().toISOString()
                        }
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Trigger test successful!\nMessage: ${result.rendered_message}\nExecution time: ${result.execution_time}ms`);
                } else {
                    alert('Trigger test failed: ' + (result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error testing trigger:', error);
                alert('Error testing trigger: ' + error.message);
            }
        }

        async function deleteTrigger(triggerId) {
            if (!confirm('Are you sure you want to delete this trigger? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/triggers/${triggerId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Trigger deleted successfully!');
                    loadTriggers(); // Reload the list
                } else {
                    const error = await response.json();
                    alert('Error deleting trigger: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting trigger:', error);
                alert('Error deleting trigger: ' + error.message);
            }
        }

        function showEditTriggerModal(trigger) {
            // Debug logging
            console.log('showEditTriggerModal called with:', trigger);

            // Ensure trigger data is valid
            if (!trigger || !trigger.id) {
                console.error('Invalid trigger data:', trigger);
                alert('Error: Invalid trigger data');
                return;
            }

            // Create edit modal with trigger data
            const modalHtml = `
                <div class="modal fade" id="editTriggerModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Trigger: ${trigger.name || 'Unknown'}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="edit-trigger-form">
                                    <input type="hidden" id="edit-trigger-id" value="${trigger.id}">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Trigger Name</label>
                                                <input type="text" class="form-control" id="edit-trigger-name" value="${trigger.name || ''}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Trigger Type</label>
                                                <select class="form-select" id="edit-trigger-type" required>
                                                    <option value="first_message_received" ${trigger.trigger_type === 'first_message_received' ? 'selected' : ''}>First Message Received</option>
                                                    <option value="seconds_after_first_message" ${trigger.trigger_type === 'seconds_after_first_message' ? 'selected' : ''}>Seconds After First Message</option>
                                                    <option value="minutes_after_first_message" ${trigger.trigger_type === 'minutes_after_first_message' ? 'selected' : ''}>Minutes After First Message</option>
                                                    <option value="event_based" ${trigger.trigger_type === 'event_based' ? 'selected' : ''}>Event Based</option>
                                                    <option value="negative_sentiment_detected" ${trigger.trigger_type === 'negative_sentiment_detected' ? 'selected' : ''}>Negative Sentiment Detected</option>
                                                    <option value="positive_sentiment_detected" ${trigger.trigger_type === 'positive_sentiment_detected' ? 'selected' : ''}>Positive Sentiment Detected</option>
                                                    <option value="guest_complaint" ${trigger.trigger_type === 'guest_complaint' ? 'selected' : ''}>Guest Complaint</option>
                                                    <option value="review_request_time" ${trigger.trigger_type === 'review_request_time' ? 'selected' : ''}>Review Request Time</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Priority</label>
                                                <input type="number" class="form-control" id="edit-trigger-priority" value="${trigger.priority || 1}" min="1" max="10">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" id="edit-trigger-status">
                                                    <option value="true" ${trigger.is_active ? 'selected' : ''}>Active</option>
                                                    <option value="false" ${!trigger.is_active ? 'selected' : ''}>Inactive</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Message Template</label>
                                        <textarea class="form-control" id="edit-trigger-message" rows="4" placeholder="Enter the message template...">${trigger.message_template || ''}</textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="updateTrigger()">Update Trigger</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('editTriggerModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editTriggerModal'));
            modal.show();
        }

        async function updateTrigger() {
            try {
                const triggerId = document.getElementById('edit-trigger-id').value;
                console.log('updateTrigger called with ID:', triggerId);

                if (!triggerId) {
                    alert('Error: No trigger ID found');
                    return;
                }

                const triggerData = {
                    name: document.getElementById('edit-trigger-name').value,
                    trigger_type: document.getElementById('edit-trigger-type').value,
                    priority: parseInt(document.getElementById('edit-trigger-priority').value),
                    is_active: document.getElementById('edit-trigger-status').value === 'true',
                    message_template: document.getElementById('edit-trigger-message').value
                };

                const response = await fetch(`/api/v1/triggers/${triggerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(triggerData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Trigger updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editTriggerModal')).hide();
                    loadTriggers(); // Reload the triggers list
                } else {
                    alert('Error updating trigger: ' + (result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating trigger:', error);
                alert('Error updating trigger: ' + error.message);
            }
        }

        function showCreateTriggerModal() {
            // Create a simple modal for trigger creation
            const modalHtml = `
                <div class="modal fade" id="createTriggerModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Create New Trigger</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="create-trigger-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Trigger Name</label>
                                                <input type="text" class="form-control" id="trigger-name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Trigger Type</label>
                                                <select class="form-select" id="trigger-type" required>
                                                    <option value="TIME_BASED">Time Based</option>
                                                    <option value="CONDITION_BASED">Condition Based</option>
                                                    <option value="EVENT_BASED">Event Based</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Priority</label>
                                                <input type="number" class="form-control" id="trigger-priority" min="1" max="10" value="5">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" id="trigger-status">
                                                    <option value="true">Active</option>
                                                    <option value="false">Inactive</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Message Template</label>
                                        <textarea class="form-control" id="trigger-template" rows="4"
                                                  placeholder="Enter message template with variables like {guest_name}, {room_number}..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Trigger Conditions (JSON)</label>
                                        <textarea class="form-control" id="trigger-conditions" rows="3"
                                                  placeholder='{"delay_minutes": 60, "event": "check_in"}'></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createTrigger()">Create Trigger</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('createTriggerModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createTriggerModal'));
            modal.show();
        }

        async function createTrigger() {
            const formData = {
                name: document.getElementById('trigger-name').value,
                trigger_type: document.getElementById('trigger-type').value,
                priority: parseInt(document.getElementById('trigger-priority').value),
                is_active: document.getElementById('trigger-status').value === 'true',
                message_template: document.getElementById('trigger-template').value,
                conditions: JSON.parse(document.getElementById('trigger-conditions').value || '{}')
            };

            try {
                const response = await fetch('/api/v1/triggers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('Trigger created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createTriggerModal')).hide();
                    loadTriggers(); // Reload the list
                } else {
                    const error = await response.json();
                    alert('Error creating trigger: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating trigger:', error);
                alert('Error creating trigger: ' + error.message);
            }
        }

        function showCreateTriggersFromTemplatesModal() {
            const modalHtml = `
                <div class="modal fade" id="createTriggersFromTemplatesModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-magic me-2"></i>Create Triggers from Templates
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Hotel Trigger Templates:</strong> Create pre-configured triggers designed to improve guest experience and increase positive reviews.
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Select Hotel</label>
                                    <select class="form-select" id="template-hotel-selector" required>
                                        <option value="">Select a hotel...</option>
                                    </select>
                                    <small class="text-muted">Choose the hotel to create triggers for</small>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Welcome & Onboarding</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success me-2"></i>Welcome Message - Immediate</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Quick Response - 30 seconds</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Experience Enhancement</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success me-2"></i>Check-in Day Welcome</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Mid-Stay Check-in</li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Review Optimization</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success me-2"></i>Pre-Checkout Satisfaction Check</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Negative Sentiment Response</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Post-Stay Review Request</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary">Complaint Handling</h6>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-check text-success me-2"></i>Complaint Escalation</li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Note:</strong> These templates will create multiple triggers. You can customize them after creation.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createTriggersFromTemplates()">
                                    <i class="fas fa-magic me-1"></i>Create All Triggers
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('createTriggersFromTemplatesModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Load hotels for selector
            loadHotelsForTemplateSelector();

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createTriggersFromTemplatesModal'));
            modal.show();
        }

        async function loadHotelsForTemplateSelector() {
            try {
                const response = await fetch('/api/v1/hotels');
                const data = await response.json();

                const selector = document.getElementById('template-hotel-selector');
                selector.innerHTML = '<option value="">Select a hotel...</option>';

                // Handle different response formats
                let hotels = [];
                if (data.status === 'success' && data.data) {
                    if (Array.isArray(data.data)) {
                        hotels = data.data;
                    } else if (data.data.hotels) {
                        hotels = data.data.hotels;
                    }
                } else if (Array.isArray(data)) {
                    hotels = data;
                } else if (data.hotels) {
                    hotels = data.hotels;
                }

                hotels.forEach(hotel => {
                    const option = document.createElement('option');
                    option.value = hotel.id;
                    option.textContent = hotel.name;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading hotels for template selector:', error);
            }
        }

        async function createTriggersFromTemplates() {
            const hotelId = document.getElementById('template-hotel-selector').value;

            if (!hotelId) {
                alert('Please select a hotel first');
                return;
            }

            try {
                const response = await fetch(`/api/v1/hotels/${hotelId}/triggers/templates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Successfully created ${result.triggers.length} trigger templates!`);
                    bootstrap.Modal.getInstance(document.getElementById('createTriggersFromTemplatesModal')).hide();
                    loadTriggers(); // Reload the triggers list
                } else {
                    alert('Error creating trigger templates: ' + (result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating trigger templates:', error);
                alert('Error creating trigger templates: ' + error.message);
            }
        }

        function filterTemplates() {
            console.log('Filter templates');
        }

        // Create Trigger function with dynamic conditions
        async function createTrigger() {
            try {
                const triggerType = document.getElementById('triggerType').value;
                const triggerData = {
                    name: document.getElementById('triggerName').value,
                    trigger_type: triggerType,
                    message_template: document.getElementById('triggerMessage').value,
                    priority: parseInt(document.getElementById('triggerPriority').value),
                    is_active: document.getElementById('triggerActive').checked,
                    conditions: buildTriggerConditions(triggerType)
                };

                const response = await fetch('/api/v1/triggers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(triggerData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Trigger created:', result);

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createTriggerModal'));
                    modal.hide();

                    // Refresh triggers list
                    loadTriggers();

                    // Show success message
                    alert('Trigger created successfully!');
                } else {
                    const error = await response.json();
                    console.error('Error creating trigger:', error);
                    alert('Error creating trigger: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating trigger:', error);
                alert('Error creating trigger: ' + error.message);
            }
        }

        // Create Template function
        async function createTemplate() {
            try {
                const templateData = {
                    name: document.getElementById('templateName').value,
                    category: document.getElementById('templateCategory').value,
                    language: document.getElementById('templateLanguage').value,
                    content: document.getElementById('templateContent').value,
                    description: document.getElementById('templateDescription').value,
                    variables: extractVariablesFromTemplate(document.getElementById('templateContent').value)
                };

                const response = await fetch('/api/v1/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(templateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Template created:', result);

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createTemplateModal'));
                    modal.hide();

                    // Refresh templates list
                    loadTemplates();

                    // Show success message
                    alert('Template created successfully!');
                } else {
                    const error = await response.json();
                    console.error('Error creating template:', error);
                    alert('Error creating template: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating template:', error);
                alert('Error creating template: ' + error.message);
            }
        }

        // Helper function to extract variables from template
        function extractVariablesFromTemplate(content) {
            const regex = /\{\{([^}]+)\}\}/g;
            const variables = [];
            let match;

            while ((match = regex.exec(content)) !== null) {
                const variable = match[1].trim();
                if (!variables.includes(variable)) {
                    variables.push(variable);
                }
            }

            return variables;
        }

        // Update trigger settings based on selected type
        function updateTriggerSettings() {
            const triggerType = document.getElementById('triggerType').value;
            const settingsContainer = document.getElementById('triggerSettings');

            if (!triggerType) {
                settingsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Select a trigger type to configure specific settings
                    </div>
                `;
                return;
            }

            let settingsHtml = '';

            if (triggerType === 'time_based') {
                settingsHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-clock me-2"></i>Time-Based Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Schedule Type</label>
                                <select class="form-select" id="scheduleType" onchange="updateTimeSettings()">
                                    <option value="hours_after_checkin">Hours After Check-in</option>
                                    <option value="days_after_checkin">Days After Check-in</option>
                                    <option value="minutes_after_first_message">Minutes After First Message</option>
                                    <option value="specific_time">Specific Time Daily</option>
                                    <option value="cron_expression">Custom Schedule (Cron)</option>
                                </select>
                            </div>
                            <div id="timeSettings">
                                <div class="mb-3">
                                    <label class="form-label">Hours After Check-in</label>
                                    <input type="number" class="form-control" id="hoursAfter" min="0" max="8760" value="2">
                                    <small class="text-muted">0-8760 hours (max 1 year)</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Timezone</label>
                                <select class="form-select" id="timezone">
                                    <option value="Asia/Bangkok" selected>Bangkok (UTC+7)</option>
                                    <option value="UTC">UTC</option>
                                    <option value="Europe/Moscow">Moscow (UTC+3)</option>
                                    <option value="Europe/London">London (UTC+0)</option>
                                    <option value="America/New_York">New York (UTC-5)</option>
                                    <option value="Asia/Tokyo">Tokyo (UTC+9)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            } else if (triggerType === 'event_based') {
                settingsHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-bolt me-2"></i>Event-Based Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Event Type</label>
                                <select class="form-select" id="eventType">
                                    <option value="guest_checkin">Guest Check-in</option>
                                    <option value="guest_checkout">Guest Check-out</option>
                                    <option value="message_received">Message Received</option>
                                    <option value="first_message_received">First Message Received</option>
                                    <option value="negative_sentiment">Negative Sentiment Detected</option>
                                    <option value="booking_confirmed">Booking Confirmed</option>
                                    <option value="booking_cancelled">Booking Cancelled</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Delay (minutes)</label>
                                <input type="number" class="form-control" id="delayMinutes" min="0" max="10080" value="0">
                                <small class="text-muted">0-10080 minutes (max 1 week)</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Event Filters (Optional)</label>
                                <textarea class="form-control" id="eventFilters" rows="3"
                                          placeholder='{"sentiment_score": {"less_than": -0.5}}'></textarea>
                                <small class="text-muted">JSON format for additional event filtering</small>
                            </div>
                        </div>
                    </div>
                `;
            } else if (triggerType === 'condition_based') {
                settingsHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="fas fa-cogs me-2"></i>Condition-Based Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Logic Operator</label>
                                <select class="form-select" id="conditionLogic">
                                    <option value="AND">AND (all conditions must be true)</option>
                                    <option value="OR">OR (any condition can be true)</option>
                                </select>
                            </div>
                            <div id="conditionsList">
                                <div class="condition-item border rounded p-3 mb-3">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Field</label>
                                            <select class="form-select condition-field">
                                                <option value="guest.preferences.room_type">Room Type</option>
                                                <option value="guest.stay_duration">Stay Duration</option>
                                                <option value="guest.is_vip">VIP Status</option>
                                                <option value="booking.total_amount">Booking Amount</option>
                                                <option value="sentiment.last_score">Last Sentiment Score</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Operator</label>
                                            <select class="form-select condition-operator">
                                                <option value="equals">Equals</option>
                                                <option value="not_equals">Not Equals</option>
                                                <option value="greater_than">Greater Than</option>
                                                <option value="less_than">Less Than</option>
                                                <option value="contains">Contains</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Value</label>
                                            <input type="text" class="form-control condition-value" placeholder="suite">
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeCondition(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCondition()">
                                <i class="fas fa-plus me-1"></i>Add Condition
                            </button>
                        </div>
                    </div>
                `;
            }

            settingsContainer.innerHTML = settingsHtml;
        }

        // Update time settings based on schedule type
        function updateTimeSettings() {
            const scheduleType = document.getElementById('scheduleType').value;
            const timeSettings = document.getElementById('timeSettings');

            let settingsHtml = '';

            if (scheduleType === 'hours_after_checkin') {
                settingsHtml = `
                    <div class="mb-3">
                        <label class="form-label">Hours After Check-in</label>
                        <input type="number" class="form-control" id="hoursAfter" min="0" max="8760" value="2">
                        <small class="text-muted">0-8760 hours (max 1 year)</small>
                    </div>
                `;
            } else if (scheduleType === 'days_after_checkin') {
                settingsHtml = `
                    <div class="mb-3">
                        <label class="form-label">Days After Check-in</label>
                        <input type="number" class="form-control" id="daysAfter" min="0" max="365" value="1">
                        <small class="text-muted">0-365 days (max 1 year)</small>
                    </div>
                `;
            } else if (scheduleType === 'minutes_after_first_message') {
                settingsHtml = `
                    <div class="mb-3">
                        <label class="form-label">Minutes After First Message</label>
                        <input type="number" class="form-control" id="minutesAfterMessage" min="1" max="10080" value="60">
                        <small class="text-muted">Trigger after first incoming or outgoing message (1-10080 minutes)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message Type</label>
                        <select class="form-select" id="messageType">
                            <option value="any">Any Message (Incoming or Outgoing)</option>
                            <option value="incoming">Incoming Messages Only</option>
                            <option value="outgoing">Outgoing Messages Only</option>
                        </select>
                    </div>
                `;
            } else if (scheduleType === 'specific_time') {
                settingsHtml = `
                    <div class="mb-3">
                        <label class="form-label">Time of Day</label>
                        <input type="time" class="form-control" id="specificTime" value="10:00">
                        <small class="text-muted">Daily at this time</small>
                    </div>
                `;
            } else if (scheduleType === 'cron_expression') {
                settingsHtml = `
                    <div class="mb-3">
                        <label class="form-label">Cron Expression</label>
                        <input type="text" class="form-control" id="cronExpression" placeholder="0 10 * * *">
                        <small class="text-muted">
                            Examples: "0 10 * * *" (daily at 10:00), "0 9 * * 1" (Mondays at 9:00)
                        </small>
                    </div>
                `;
            }

            timeSettings.innerHTML = settingsHtml;
        }

        // Add new condition for condition-based triggers
        function addCondition() {
            const conditionsList = document.getElementById('conditionsList');
            const newCondition = `
                <div class="condition-item border rounded p-3 mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Field</label>
                            <select class="form-select condition-field">
                                <option value="guest.preferences.room_type">Room Type</option>
                                <option value="guest.stay_duration">Stay Duration</option>
                                <option value="guest.is_vip">VIP Status</option>
                                <option value="booking.total_amount">Booking Amount</option>
                                <option value="sentiment.last_score">Last Sentiment Score</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Operator</label>
                            <select class="form-select condition-operator">
                                <option value="equals">Equals</option>
                                <option value="not_equals">Not Equals</option>
                                <option value="greater_than">Greater Than</option>
                                <option value="less_than">Less Than</option>
                                <option value="contains">Contains</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Value</label>
                            <input type="text" class="form-control condition-value" placeholder="suite">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeCondition(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            conditionsList.insertAdjacentHTML('beforeend', newCondition);
        }

        // Remove condition
        function removeCondition(button) {
            const conditionItem = button.closest('.condition-item');
            conditionItem.remove();
        }

        // Build trigger conditions based on type
        function buildTriggerConditions(triggerType) {
            if (triggerType === 'time_based') {
                const scheduleType = document.getElementById('scheduleType').value;
                const timezone = document.getElementById('timezone').value;

                const conditions = {
                    schedule_type: scheduleType,
                    timezone: timezone
                };

                if (scheduleType === 'hours_after_checkin') {
                    conditions.hours_after = parseInt(document.getElementById('hoursAfter').value);
                } else if (scheduleType === 'days_after_checkin') {
                    conditions.days_after = parseInt(document.getElementById('daysAfter').value);
                } else if (scheduleType === 'minutes_after_first_message') {
                    conditions.minutes_after_message = parseInt(document.getElementById('minutesAfterMessage').value);
                    conditions.message_type = document.getElementById('messageType').value;
                } else if (scheduleType === 'specific_time') {
                    conditions.specific_time = document.getElementById('specificTime').value;
                } else if (scheduleType === 'cron_expression') {
                    conditions.cron_expression = document.getElementById('cronExpression').value;
                }

                return { time_based: conditions };

            } else if (triggerType === 'event_based') {
                const eventType = document.getElementById('eventType').value;
                const delayMinutes = parseInt(document.getElementById('delayMinutes').value);
                const eventFiltersText = document.getElementById('eventFilters').value;

                const conditions = {
                    event_type: eventType,
                    delay_minutes: delayMinutes
                };

                if (eventFiltersText.trim()) {
                    try {
                        conditions.event_filters = JSON.parse(eventFiltersText);
                    } catch (e) {
                        console.warn('Invalid JSON in event filters, ignoring:', e);
                    }
                }

                return { event_based: conditions };

            } else if (triggerType === 'condition_based') {
                const logic = document.getElementById('conditionLogic').value;
                const conditionItems = document.querySelectorAll('.condition-item');

                const conditions = [];
                conditionItems.forEach(item => {
                    const field = item.querySelector('.condition-field').value;
                    const operator = item.querySelector('.condition-operator').value;
                    const value = item.querySelector('.condition-value').value;

                    if (field && operator && value) {
                        conditions.push({
                            field: field,
                            operator: operator,
                            value: value
                        });
                    }
                });

                return {
                    condition_based: {
                        conditions: conditions,
                        logic: logic
                    }
                };
            }

            return {};
        }

        // DeepSeek Settings Functions
        async function loadDeepSeekSettings() {
            try {
                const response = await fetch('/api/v1/admin/settings?category=deepseek');
                const data = await response.json();

                if (data.status === 'success' && data.data.settings) {
                    const settings = data.data.settings;

                    // Populate form fields
                    document.getElementById('deepseek-api-key').value = settings.api_key || '';
                    document.getElementById('deepseek-model').value = settings.model || 'deepseek-chat';
                    document.getElementById('deepseek-max-tokens').value = settings.max_tokens || 4096;
                    document.getElementById('deepseek-temperature').value = settings.temperature || 0.7;
                    document.getElementById('deepseek-requests-per-minute').value = settings.requests_per_minute || 50;
                    document.getElementById('deepseek-tokens-per-minute').value = settings.tokens_per_minute || 100000;
                    document.getElementById('deepseek-timeout').value = settings.timeout || 60;
                    document.getElementById('deepseek-max-retries').value = settings.max_retries || 3;
                    document.getElementById('deepseek-travel-memory').value = settings.travel_memory || '';

                    // Update status
                    document.getElementById('deepseek-current-model').textContent = settings.model || 'deepseek-chat';
                    document.getElementById('deepseek-memory-size').textContent =
                        Math.round((settings.travel_memory || '').length / 1024) + ' KB';

                    console.log('DeepSeek settings loaded successfully');
                }
            } catch (error) {
                console.error('Error loading DeepSeek settings:', error);
                alert('Error loading DeepSeek settings: ' + error.message);
            }
        }

        async function saveDeepSeekSettings() {
            try {
                const settingsData = {
                    category: 'deepseek',
                    settings: {
                        api_key: document.getElementById('deepseek-api-key').value,
                        model: document.getElementById('deepseek-model').value,
                        max_tokens: parseInt(document.getElementById('deepseek-max-tokens').value),
                        temperature: parseFloat(document.getElementById('deepseek-temperature').value),
                        requests_per_minute: parseInt(document.getElementById('deepseek-requests-per-minute').value),
                        tokens_per_minute: parseInt(document.getElementById('deepseek-tokens-per-minute').value),
                        timeout: parseInt(document.getElementById('deepseek-timeout').value),
                        max_retries: parseInt(document.getElementById('deepseek-max-retries').value),
                        travel_memory: document.getElementById('deepseek-travel-memory').value
                    }
                };

                const response = await fetch('/api/v1/admin/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('DeepSeek settings saved successfully!');
                    loadDeepSeekSettings(); // Reload to show updated values
                } else {
                    alert('Error saving settings: ' + (result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving DeepSeek settings:', error);
                alert('Error saving DeepSeek settings: ' + error.message);
            }
        }

        async function testDeepSeekConnection() {
            try {
                document.getElementById('deepseek-api-status').textContent = 'Testing...';

                const response = await fetch('/api/v1/deepseek/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: document.getElementById('deepseek-api-key').value,
                        model: document.getElementById('deepseek-model').value
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    document.getElementById('deepseek-api-status').textContent = 'Connected ✓';
                    document.getElementById('deepseek-api-status').className = 'text-success';
                    alert('DeepSeek connection successful!');
                } else {
                    document.getElementById('deepseek-api-status').textContent = 'Failed ✗';
                    document.getElementById('deepseek-api-status').className = 'text-danger';
                    alert('Connection failed: ' + (result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error testing DeepSeek connection:', error);
                document.getElementById('deepseek-api-status').textContent = 'Error ✗';
                document.getElementById('deepseek-api-status').className = 'text-danger';
                alert('Error testing connection: ' + error.message);
            }
        }

        // Hotel-Specific DeepSeek Functions
        async function loadHotelsForDeepSeekSelector() {
            try {
                const response = await fetch('/api/v1/hotels');
                const data = await response.json();

                const selector = document.getElementById('deepseek-hotel-selector');
                selector.innerHTML = '<option value="">Select a hotel to configure...</option>';

                // Handle different response formats
                let hotels = [];
                if (data.status === 'success' && data.data) {
                    if (Array.isArray(data.data)) {
                        hotels = data.data;
                    } else if (data.data.hotels) {
                        hotels = data.data.hotels;
                    }
                } else if (Array.isArray(data)) {
                    hotels = data;
                } else if (data.hotels) {
                    hotels = data.hotels;
                }

                hotels.forEach(hotel => {
                    const option = document.createElement('option');
                    option.value = hotel.id;
                    option.textContent = hotel.name;
                    selector.appendChild(option);
                });

                console.log('Hotels loaded for DeepSeek selector:', hotels.length);
            } catch (error) {
                console.error('Error loading hotels for DeepSeek selector:', error);
            }
        }

        async function loadHotelDeepSeekSettings() {
            const hotelId = document.getElementById('deepseek-hotel-selector').value;

            if (!hotelId) {
                // Disable all form fields and buttons
                disableDeepSeekForm();
                return;
            }

            try {
                const response = await fetch(`/api/v1/hotels/${hotelId}/deepseek`);
                const data = await response.json();

                if (data && data.status === 'success' && data.data) {
                    const settings = data.data;

                    // Populate form fields
                    document.getElementById('deepseek-api-key').value = settings.api_key || '';
                    document.getElementById('deepseek-model').value = settings.model || 'deepseek-chat';
                    document.getElementById('deepseek-max-tokens').value = settings.max_tokens || 4096;
                    document.getElementById('deepseek-temperature').value = settings.temperature || 0.7;
                    document.getElementById('deepseek-requests-per-minute').value = settings.max_requests_per_minute || 50;
                    document.getElementById('deepseek-tokens-per-minute').value = settings.max_tokens_per_minute || 100000;
                    document.getElementById('deepseek-timeout').value = settings.timeout || 60;
                    document.getElementById('deepseek-max-retries').value = settings.max_retries || 3;
                    document.getElementById('deepseek-travel-memory').value = settings.travel_memory || '';
                    document.getElementById('deepseek-style').value = settings.response_style || 'professional';

                    // Update temperature display
                    document.getElementById('temp-value').textContent = settings.temperature || 0.7;

                    // Enable form
                    enableDeepSeekForm();

                    console.log('Hotel DeepSeek settings loaded successfully');
                } else {
                    // No settings found, use defaults
                    resetHotelDeepSeekSettings();
                    enableDeepSeekForm();
                }
            } catch (error) {
                console.error('Error loading hotel DeepSeek settings:', error);
                alert('Error loading hotel settings: ' + error.message);
            }
        }

        async function saveHotelDeepSeekSettings() {
            const hotelId = document.getElementById('deepseek-hotel-selector').value;

            if (!hotelId) {
                alert('Please select a hotel first');
                return;
            }

            try {
                const settingsData = {
                    enabled: true,
                    api_key: document.getElementById('deepseek-api-key').value,
                    model: document.getElementById('deepseek-model').value,
                    max_tokens: parseInt(document.getElementById('deepseek-max-tokens').value),
                    temperature: parseFloat(document.getElementById('deepseek-temperature').value),
                    timeout: parseInt(document.getElementById('deepseek-timeout').value),
                    max_requests_per_minute: parseInt(document.getElementById('deepseek-requests-per-minute').value),
                    max_tokens_per_minute: parseInt(document.getElementById('deepseek-tokens-per-minute').value),
                    max_retries: parseInt(document.getElementById('deepseek-max-retries').value),
                    travel_memory: document.getElementById('deepseek-travel-memory').value,
                    response_style: document.getElementById('deepseek-style').value
                };

                const response = await fetch(`/api/v1/hotels/${hotelId}/deepseek`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Hotel DeepSeek settings saved successfully!');
                    loadHotelDeepSeekSettings(); // Reload to show updated values
                } else {
                    alert('Error saving settings: ' + (result.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving hotel DeepSeek settings:', error);
                alert('Error saving settings: ' + error.message);
            }
        }

        async function testHotelDeepSeekConnection() {
            const hotelId = document.getElementById('deepseek-hotel-selector').value;

            if (!hotelId) {
                alert('Please select a hotel first');
                return;
            }

            try {
                const response = await fetch(`/api/v1/hotels/${hotelId}/deepseek/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('DeepSeek connection successful for this hotel!');
                } else {
                    alert('Connection failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error testing hotel DeepSeek connection:', error);
                alert('Error testing connection: ' + error.message);
            }
        }

        function resetHotelDeepSeekSettings() {
            // Reset to default values
            document.getElementById('deepseek-api-key').value = '';
            document.getElementById('deepseek-model').value = 'deepseek-chat';
            document.getElementById('deepseek-max-tokens').value = 4096;
            document.getElementById('deepseek-temperature').value = 0.7;
            document.getElementById('deepseek-requests-per-minute').value = 50;
            document.getElementById('deepseek-tokens-per-minute').value = 100000;
            document.getElementById('deepseek-timeout').value = 60;
            document.getElementById('deepseek-max-retries').value = 3;
            document.getElementById('deepseek-travel-memory').value = '';

            // Update temperature display
            document.getElementById('temp-value').textContent = '0.7';
        }

        function enableDeepSeekForm() {
            // Enable all form fields
            document.getElementById('deepseek-api-key').disabled = false;
            document.getElementById('deepseek-model').disabled = false;
            document.getElementById('deepseek-max-tokens').disabled = false;
            document.getElementById('deepseek-temperature').disabled = false;
            document.getElementById('deepseek-requests-per-minute').disabled = false;
            document.getElementById('deepseek-tokens-per-minute').disabled = false;
            document.getElementById('deepseek-timeout').disabled = false;
            document.getElementById('deepseek-max-retries').disabled = false;
            document.getElementById('deepseek-travel-memory').disabled = false;
            document.getElementById('deepseek-style').disabled = false;

            // Enable buttons
            document.getElementById('save-deepseek-btn').disabled = false;
            document.getElementById('reload-deepseek-btn').disabled = false;
            document.getElementById('test-deepseek-btn').disabled = false;
            document.getElementById('reset-deepseek-btn').disabled = false;
        }

        function disableDeepSeekForm() {
            // Disable all form fields
            document.getElementById('deepseek-api-key').disabled = true;
            document.getElementById('deepseek-model').disabled = true;
            document.getElementById('deepseek-max-tokens').disabled = true;
            document.getElementById('deepseek-temperature').disabled = true;
            document.getElementById('deepseek-requests-per-minute').disabled = true;
            document.getElementById('deepseek-tokens-per-minute').disabled = true;
            document.getElementById('deepseek-timeout').disabled = true;
            document.getElementById('deepseek-max-retries').disabled = true;
            document.getElementById('deepseek-travel-memory').disabled = true;
            document.getElementById('deepseek-style').disabled = true;

            // Disable buttons
            document.getElementById('save-deepseek-btn').disabled = true;
            document.getElementById('reload-deepseek-btn').disabled = true;
            document.getElementById('test-deepseek-btn').disabled = true;
            document.getElementById('reset-deepseek-btn').disabled = true;

            // Clear form
            resetHotelDeepSeekSettings();
        }

        // Trigger Demo Functions
        let activeTriggerTests = [];

        function testTimeTrigger(seconds) {
            const testId = Date.now();
            const triggerTest = {
                id: testId,
                type: 'time_based',
                description: `${seconds}s After Check-in`,
                startTime: Date.now(),
                duration: seconds * 1000
            };

            activeTriggerTests.push(triggerTest);
            updateActiveTriggers();

            addTriggerResult(`⏰ Time-based trigger started: ${seconds} seconds`, 'info');

            setTimeout(() => {
                addTriggerResult(`✅ Time trigger fired: Welcome message sent!`, 'success');
                removeTriggerTest(testId);
            }, seconds * 1000);
        }

        function testEventTrigger(eventType) {
            addTriggerResult(`📨 Event trigger: ${eventType} - Processing...`, 'info');

            setTimeout(() => {
                addTriggerResult(`✅ Event trigger fired: Auto-response sent!`, 'success');
            }, 1000);
        }

        function testSentimentTrigger() {
            addTriggerResult(`😔 Sentiment trigger: Negative sentiment detected`, 'warning');

            setTimeout(() => {
                addTriggerResult(`🚨 Staff notification sent! Manager will contact guest.`, 'danger');
            }, 2000);
        }

        function testFirstMessageTrigger(seconds) {
            const testId = Date.now();
            const triggerTest = {
                id: testId,
                type: 'first_message',
                description: `${seconds}s After First Message`,
                startTime: Date.now(),
                duration: seconds * 1000
            };

            activeTriggerTests.push(triggerTest);
            updateActiveTriggers();

            addTriggerResult(`💬 First message trigger started: ${seconds} seconds`, 'info');

            setTimeout(() => {
                addTriggerResult(`✅ Follow-up message sent: "How was your first day?"`, 'success');
                removeTriggerTest(testId);
            }, seconds * 1000);
        }

        function testVIPTrigger() {
            addTriggerResult(`👑 VIP condition trigger: Checking guest status...`, 'info');

            setTimeout(() => {
                addTriggerResult(`✨ VIP trigger fired: Special welcome message with champagne offer!`, 'success');
            }, 1500);
        }

        function clearTriggerTests() {
            activeTriggerTests = [];
            updateActiveTriggers();
            document.getElementById('trigger-test-results').innerHTML = '';
        }

        function addTriggerResult(message, type) {
            const resultsDiv = document.getElementById('trigger-test-results');
            const alertClass = type === 'success' ? 'alert-success' :
                             type === 'warning' ? 'alert-warning' :
                             type === 'danger' ? 'alert-danger' : 'alert-info';

            const resultHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            resultsDiv.insertAdjacentHTML('afterbegin', resultHtml);
        }

        function updateActiveTriggers() {
            const activeDiv = document.getElementById('active-triggers');

            if (activeTriggerTests.length === 0) {
                activeDiv.innerHTML = '<div class="text-muted">No active tests</div>';
                return;
            }

            const html = activeTriggerTests.map(test => {
                const elapsed = Math.floor((Date.now() - test.startTime) / 1000);
                const remaining = Math.max(0, Math.floor(test.duration / 1000) - elapsed);

                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <small>${test.description}</small>
                        <span class="badge bg-primary">${remaining}s</span>
                    </div>
                `;
            }).join('');

            activeDiv.innerHTML = html;
        }

        function removeTriggerTest(testId) {
            activeTriggerTests = activeTriggerTests.filter(test => test.id !== testId);
            updateActiveTriggers();
        }

        // AI Configuration Functions
        function loadAIConfiguration() {
            console.log('Loading AI Configuration section');
            // Load AI configuration data
            fetch('/api/v1/deepseek/health')
                .then(response => response.json())
                .then(data => {
                    console.log('AI Configuration data loaded:', data);
                })
                .catch(error => console.error('Error loading AI configuration:', error));
        }

        function saveAIConfig() {
            const config = {
                api_key: document.getElementById('ai-api-key').value,
                model: document.getElementById('ai-model').value,
                max_tokens: parseInt(document.getElementById('ai-max-tokens').value),
                temperature: parseFloat(document.getElementById('ai-temperature').value),
                language: document.getElementById('ai-language').value,
                system_prompt: document.getElementById('ai-system-prompt').value
            };

            // Simulate API call
            console.log('Saving AI config:', config);

            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>AI Configuration saved successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            document.querySelector('#ai-config-form').insertAdjacentHTML('beforebegin', alertHtml);
        }

        function testAIConnection() {
            const apiKey = document.getElementById('ai-api-key').value;

            if (!apiKey) {
                alert('Please enter an API key first');
                return;
            }

            // Simulate connection test
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testing...';
            button.disabled = true;

            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-check me-1"></i>Connection Successful!';
                button.className = 'btn btn-success';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = 'btn btn-outline-secondary';
                    button.disabled = false;
                }, 2000);
            }, 2000);
        }

        function resetAIConfig() {
            if (confirm('Are you sure you want to reset to default settings?')) {
                document.getElementById('ai-api-key').value = '';
                document.getElementById('ai-model').value = 'deepseek-chat';
                document.getElementById('ai-max-tokens').value = '1000';
                document.getElementById('ai-temperature').value = '0.7';
                document.getElementById('temperature-value').textContent = '0.7';
                document.getElementById('ai-language').value = 'en';
                document.getElementById('ai-system-prompt').value = 'You are a helpful hotel assistant. Respond professionally and courteously to guest inquiries.';
            }
        }

        function testAIResponse() {
            const testMessage = document.getElementById('test-message').value;
            const outputDiv = document.getElementById('ai-response-output');

            if (!testMessage.trim()) {
                alert('Please enter a test message');
                return;
            }

            // Show loading
            outputDiv.innerHTML = '<div class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Generating AI response...</div>';

            // Simulate AI response
            setTimeout(() => {
                const mockResponse = `
                    <div class="ai-response">
                        <div class="d-flex align-items-start">
                            <div class="me-2">
                                <i class="fas fa-robot text-primary"></i>
                            </div>
                            <div>
                                <strong>AI Assistant:</strong><br>
                                Hello! I'd be happy to help you with your room booking. Could you please provide me with your booking reference number or the name the reservation was made under? This will allow me to quickly access your booking details and assist you with any questions or changes you might need.
                                <div class="mt-2 small text-muted">
                                    <i class="fas fa-clock me-1"></i>Response time: 1.2s | Tokens used: 45
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                outputDiv.innerHTML = mockResponse;
            }, 1500);
        }

        // Update temperature display
        document.addEventListener('DOMContentLoaded', function() {
            const temperatureSlider = document.getElementById('ai-temperature');
            const temperatureValue = document.getElementById('temperature-value');

            if (temperatureSlider && temperatureValue) {
                temperatureSlider.addEventListener('input', function() {
                    temperatureValue.textContent = this.value;
                });
            }
        });

        // Travel Demo Functions
        let travelConversationId = null;
        let currentTravelStep = null;

        async function startTravelDemo() {
            const phoneNumber = document.getElementById('travel-guest-phone').value;
            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }

            // Detect language from phone number
            const language = detectLanguageFromPhone(phoneNumber);
            document.getElementById('detected-language').textContent = language.toUpperCase();

            // Show conversation area
            document.getElementById('travel-conversation-demo').style.display = 'block';

            // Start conversation
            const greeting = "Здравствуйте! Я могу улучшить ваш отпуск на 50% больше эмоций и впечатлений бесплатно. У меня есть лучшие варианты как провести время. Хотите узнать?";

            addTravelMessage('bot', greeting);
            currentTravelStep = 'greeting';

            // Update language detection info
            document.getElementById('language-detection-info').innerHTML = `
                <div class="mb-2">
                    <strong>Phone:</strong> ${phoneNumber}<br>
                    <strong>Detected:</strong> ${language.toUpperCase()}<br>
                    <strong>Confidence:</strong> 85%
                </div>
            `;
        }

        function detectLanguageFromPhone(phone) {
            if (phone.startsWith('+7') || phone.startsWith('7')) return 'ru';
            if (phone.startsWith('+66') || phone.startsWith('66')) return 'th';
            if (phone.startsWith('+86') || phone.startsWith('86')) return 'zh';
            if (phone.startsWith('+1') || phone.startsWith('1')) return 'en';
            return 'en'; // default
        }

        function sendTravelMessage() {
            const input = document.getElementById('travel-user-input');
            const message = input.value.trim();

            if (!message) return;

            addTravelMessage('user', message);
            input.value = '';

            // Process response based on current step
            setTimeout(() => {
                processTravelResponse(message);
            }, 1000);
        }

        function processTravelResponse(userMessage) {
            let botResponse = '';

            switch (currentTravelStep) {
                case 'greeting':
                    if (userMessage.toLowerCase().includes('да') || userMessage.toLowerCase().includes('yes')) {
                        botResponse = 'Отлично! Скажите, какой раз вы на Пхукете?\n\n1. Первый раз\n2. 2-3 раза\n3. Более 3 раз';
                        currentTravelStep = 'visit_frequency';
                    } else {
                        botResponse = 'Понимаю! Если передумаете, просто напишите мне. Хорошего отдыха!';
                        currentTravelStep = 'ended';
                    }
                    break;

                case 'visit_frequency':
                    botResponse = 'Понятно! А с кем вы приехали?\n\n1. Один/одна\n2. С партнером\n3. С детьми\n4. Компанией друзей';
                    currentTravelStep = 'companions';
                    break;

                case 'companions':
                    botResponse = 'Замечательно! Основываясь на ваших ответах, вот мои персональные рекомендации:\n\n🏖️ Пляж Ката - идеален для пар\n🌅 Смотровая Промтеп - лучшие закаты\n🍽️ Ресторан Mom Tri\'s - романтичные ужины\n🏛️ Старый город - красивые фото\n\nХотите больше деталей по любой из рекомендаций?';
                    currentTravelStep = 'recommendations';
                    break;

                default:
                    botResponse = 'Спасибо за интерес! Наслаждайтесь отдыхом на Пхукете! 🌴';
            }

            addTravelMessage('bot', botResponse);
        }

        function addTravelMessage(sender, message) {
            const messagesDiv = document.getElementById('travel-messages');
            const isBot = sender === 'bot';

            const messageHtml = `
                <div class="d-flex ${isBot ? 'justify-content-start' : 'justify-content-end'} mb-3">
                    <div class="max-width-75">
                        <div class="card ${isBot ? 'border-success' : 'border-primary'}">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-${isBot ? 'robot' : 'user'} me-2 text-${isBot ? 'success' : 'primary'}"></i>
                                    <small class="text-muted">${isBot ? 'Travel Assistant' : 'Guest'}</small>
                                </div>
                                <div style="white-space: pre-line;">${message}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.mobile-menu-toggle');

            if (!sidebar.contains(event.target) && !toggle.contains(event.target)) {
                sidebar.classList.remove('show');
            }
        });

        // Update active triggers every second
        setInterval(updateActiveTriggers, 1000);

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Users Section Functions
        function loadUsers() {
            console.log('Loading Users section');
            const usersContainer = document.getElementById('users-list');
            if (usersContainer) {
                usersContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading users...</p></div>';
            }

            fetch('/api/v1/admin/users')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && usersContainer) {
                        displayUsers(data.data);
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    if (usersContainer) {
                        usersContainer.innerHTML = '<div class="alert alert-warning">Error loading users. Please try again.</div>';
                    }
                });
        }

        function displayUsers(users) {
            const usersContainer = document.getElementById('users-list');
            if (!usersContainer) return;

            if (!users || users.length === 0) {
                usersContainer.innerHTML = '<div class="alert alert-info">No users found.</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>';

            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td><span class="badge bg-primary">${user.role || 'User'}</span></td>
                        <td><span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            usersContainer.innerHTML = html;
        }

        function editUser(userId) {
            console.log('Editing user:', userId);
            // Implement user editing functionality
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                console.log('Deleting user:', userId);
                // Implement user deletion functionality
            }
        }

        // Analytics Section Functions
        function loadAnalytics() {
            console.log('Loading Analytics section');
            const analyticsContainer = document.getElementById('analytics-content');
            if (analyticsContainer) {
                analyticsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading analytics...</p></div>';
            }

            fetch('/api/v1/admin/analytics/overview')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && analyticsContainer) {
                        displayAnalytics(data.data);
                    }
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                    if (analyticsContainer) {
                        analyticsContainer.innerHTML = '<div class="alert alert-warning">Error loading analytics. Please try again.</div>';
                    }
                });
        }

        function displayAnalytics(analytics) {
            const analyticsContainer = document.getElementById('analytics-content');
            if (!analyticsContainer) return;

            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Message Analytics</h6>
                            </div>
                            <div class="card-body">
                                <p>Total Messages: <strong>${analytics.total_messages || 0}</strong></p>
                                <p>Response Rate: <strong>${analytics.response_rate || 0}%</strong></p>
                                <p>Average Response Time: <strong>${analytics.avg_response_time || 0}s</strong></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Sentiment Analytics</h6>
                            </div>
                            <div class="card-body">
                                <p>Positive: <strong>${analytics.positive_sentiment || 0}%</strong></p>
                                <p>Neutral: <strong>${analytics.neutral_sentiment || 0}%</strong></p>
                                <p>Negative: <strong>${analytics.negative_sentiment || 0}%</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            analyticsContainer.innerHTML = html;
        }

        // Monitoring Section Functions
        function loadMonitoring() {
            console.log('Loading Monitoring section');
            const monitoringContainer = document.getElementById('monitoring-content');
            if (monitoringContainer) {
                monitoringContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading monitoring data...</p></div>';
            }

            // Try multiple endpoints to find working monitoring data
            Promise.all([
                fetch('/api/v1/admin/health').catch(() => ({ ok: false })),
                fetch('/api/v1/health').catch(() => ({ ok: false })),
                fetch('/api/v1/monitoring').catch(() => ({ ok: false }))
            ])
            .then(responses => {
                // Find the first successful response
                const successfulResponse = responses.find(r => r.ok);
                if (successfulResponse) {
                    return successfulResponse.json();
                } else {
                    // If no endpoints work, show mock data
                    return {
                        status: 'success',
                        data: {
                            system_status: 'healthy',
                            uptime: '2 days, 14 hours',
                            cpu_usage: 45,
                            db_status: 'connected',
                            db_connections: 12,
                            avg_query_time: 25,
                            green_api_status: 'connected',
                            deepseek_status: 'connected',
                            redis_status: 'connected'
                        }
                    };
                }
            })
            .then(data => {
                if (monitoringContainer) {
                    displayMonitoring(data.data || data);
                }
            })
            .catch(error => {
                console.error('Error loading monitoring:', error);
                if (monitoringContainer) {
                    monitoringContainer.innerHTML = '<div class="alert alert-warning">Error loading monitoring data. Please try again.</div>';
                }
            });
        }

        function displayMonitoring(monitoring) {
            const monitoringContainer = document.getElementById('monitoring-content');
            if (!monitoringContainer) return;

            const html = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">System Health</h6>
                            </div>
                            <div class="card-body">
                                <p>Status: <span class="badge ${monitoring.system_status === 'healthy' ? 'bg-success' : 'bg-danger'}">${monitoring.system_status || 'Unknown'}</span></p>
                                <p>Uptime: <strong>${monitoring.uptime || 'N/A'}</strong></p>
                                <p>CPU Usage: <strong>${monitoring.cpu_usage || 0}%</strong></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Database</h6>
                            </div>
                            <div class="card-body">
                                <p>Status: <span class="badge ${monitoring.db_status === 'connected' ? 'bg-success' : 'bg-danger'}">${monitoring.db_status || 'Unknown'}</span></p>
                                <p>Connections: <strong>${monitoring.db_connections || 0}</strong></p>
                                <p>Query Time: <strong>${monitoring.avg_query_time || 0}ms</strong></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">External APIs</h6>
                            </div>
                            <div class="card-body">
                                <p>Green API: <span class="badge ${monitoring.green_api_status === 'connected' ? 'bg-success' : 'bg-danger'}">${monitoring.green_api_status || 'Unknown'}</span></p>
                                <p>DeepSeek API: <span class="badge ${monitoring.deepseek_status === 'connected' ? 'bg-success' : 'bg-danger'}">${monitoring.deepseek_status || 'Unknown'}</span></p>
                                <p>Redis: <span class="badge ${monitoring.redis_status === 'connected' ? 'bg-success' : 'bg-danger'}">${monitoring.redis_status || 'Unknown'}</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            monitoringContainer.innerHTML = html;
        }

        // Security Section Functions
        function loadSecurity() {
            console.log('Loading Security section');
            const securityContainer = document.getElementById('security-content');
            if (securityContainer) {
                securityContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading security data...</p></div>';
            }

            // Load security metrics
            Promise.all([
                fetch('/api/v1/admin/security/audit-logs'),
                fetch('/api/v1/admin/security/failed-logins'),
                fetch('/api/v1/admin/security/rate-limits')
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([auditLogs, failedLogins, rateLimits]) => {
                if (securityContainer) {
                    displaySecurity({ auditLogs, failedLogins, rateLimits });
                }
            })
            .catch(error => {
                console.error('Error loading security:', error);
                if (securityContainer) {
                    securityContainer.innerHTML = '<div class="alert alert-warning">Error loading security data. Please try again.</div>';
                }
            });
        }

        function displaySecurity(security) {
            const securityContainer = document.getElementById('security-content');
            if (!securityContainer) return;

            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Security Overview</h6>
                            </div>
                            <div class="card-body">
                                <p>Failed Login Attempts: <strong>${security.failedLogins?.count || 0}</strong></p>
                                <p>Rate Limit Violations: <strong>${security.rateLimits?.violations || 0}</strong></p>
                                <p>Active Sessions: <strong>${security.auditLogs?.active_sessions || 0}</strong></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Recent Security Events</h6>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    <div class="list-group-item">No recent security events</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            securityContainer.innerHTML = html;
        }
    </script>
</body>
</html>
