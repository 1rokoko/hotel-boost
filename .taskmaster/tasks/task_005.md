# Task 005: Hotel Management System

## Описание
Создание системы управления отелями с регистрацией, конфигурацией и настройками

## Приоритет: MEDIUM
## Сложность: MEDIUM
## Оценка времени: 16 часов
## Зависимости: Task 002

## Детальный план выполнения

### Подзадача 5.1: API для управления отелями (4 часа)
**Файлы для создания:**
- `app/api/v1/endpoints/hotels.py` - CRUD операции для отелей
- `app/schemas/hotel.py` - Pydantic схемы для отелей
- `app/services/hotel_service.py` - бизнес-логика отелей

**Детали реализации:**
- CRUD операции: создание, чтение, обновление, удаление
- Валидация данных отеля
- Поиск и фильтрация отелей
- Пагинация результатов

### Подзадача 5.2: Конфигурация отелей (3 часа)
**Файлы для создания:**
- `app/services/hotel_config.py` - управление конфигурацией
- `app/models/hotel_settings.py` - модель настроек
- `app/schemas/hotel_config.py` - схемы конфигурации

**Детали реализации:**
- Настройки WhatsApp интеграции
- Конфигурация триггеров
- Персонализация сообщений
- Часовые пояса и локализация

### Подзадача 5.3: Валидация и верификация (3 часа)
**Файлы для создания:**
- `app/services/hotel_validator.py` - валидация данных отеля
- `app/utils/whatsapp_validator.py` - проверка WhatsApp номеров
- `app/tasks/verify_hotel.py` - Celery задачи верификации

**Детали реализации:**
- Проверка корректности WhatsApp номеров
- Валидация Green API credentials
- Проверка уникальности данных
- Автоматическая верификация настроек

### Подзадача 5.4: Мультитенантность (2 часа)
**Файлы для создания:**
- `app/core/tenant_context.py` - контекст тенанта
- `app/middleware/tenant_middleware.py` - middleware для изоляции
- `app/utils/tenant_utils.py` - утилиты для работы с тенантами

**Детали реализации:**
- Изоляция данных между отелями
- Контекст текущего отеля в запросах
- Middleware для автоматического определения тенанта
- Безопасность доступа к данным

### Подзадача 5.5: Детальные тесты отелей (2 часа)
**Файлы для создания:**
- `tests/unit/test_hotel_service.py` - тесты сервиса
- `tests/unit/test_hotel_validator.py` - тесты валидации
- `tests/integration/test_hotel_api.py` - интеграционные тесты
- `tests/unit/test_tenant_isolation.py` - тесты изоляции

**Детали реализации:**
- Тесты CRUD операций
- Тесты валидации данных
- Тесты мультитенантности
- Тесты безопасности доступа

### Подзадача 5.6: Логирование операций отелей (1 час)
**Файлы для создания:**
- `app/core/hotel_logging.py` - логирование операций
- `app/utils/audit_logger.py` - аудит изменений

**Детали реализации:**
- Логирование всех операций с отелями
- Аудит изменений конфигурации
- Мониторинг активности отелей
- Алерты при подозрительной активности

### Подзадача 5.7: Импорт и экспорт данных (1 час)
**Файлы для создания:**
- `app/services/hotel_import.py` - импорт данных отелей
- `app/services/hotel_export.py` - экспорт данных
- `app/utils/data_migration.py` - миграция данных

**Детали реализации:**
- Импорт отелей из CSV/JSON
- Экспорт конфигурации отелей
- Миграция данных между окружениями
- Валидация импортируемых данных

## Критерии готовности
- [ ] CRUD операции для отелей работают
- [ ] Конфигурация отелей функционирует
- [ ] Валидация данных работает корректно
- [ ] Мультитенантность обеспечена
- [ ] Все тесты проходят (unit + integration)
- [ ] Логирование настроено
- [ ] Импорт/экспорт работает
- [ ] Покрытие тестами >85%

## Детальные тесты

### Unit тесты отелей:
```python
def test_create_hotel():
    """Тест создания отеля"""
    
def test_update_hotel_config():
    """Тест обновления конфигурации"""
    
def test_hotel_validation():
    """Тест валидации данных отеля"""
    
def test_tenant_isolation():
    """Тест изоляции данных тенантов"""
```

### Integration тесты:
- Тест полного цикла создания отеля
- Тест API endpoints для отелей
- Тест мультитенантной изоляции
- Тест импорта/экспорта данных

## Логирование отелей

### Структура логов:
```json
{
  "timestamp": "2025-07-11T05:00:00Z",
  "level": "INFO",
  "service": "whatsapp-hotel-bot",
  "component": "hotel_management",
  "operation": "create_hotel",
  "hotel_id": "uuid-here",
  "user_id": "admin-123",
  "changes": {
    "name": "New Hotel Name",
    "whatsapp_number": "+1234567890"
  },
  "correlation_id": "req-123456"
}
```

### Мониторинг:
- Количество активных отелей
- Частота изменений конфигурации
- Ошибки валидации
- Использование API endpoints
- Производительность операций

## Связанные задачи
- **Предыдущие задачи:** Task 002 (Database Schema)
- **Следующие задачи:** Task 006 (Trigger System), Task 011 (Admin Dashboard)
- **Блокирует:** Tasks 006, 011, 012

## Заметки
- Обеспечить строгую изоляцию данных между отелями
- Все операции должны быть аудируемыми
- Валидация должна быть комплексной
- API должно быть RESTful и интуитивным
- Поддержка массовых операций для администраторов
